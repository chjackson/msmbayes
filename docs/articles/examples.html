<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="msmbayes">
<title>Examples of using msmbayes • msmbayes</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Examples of using msmbayes">
<meta property="og:description" content="msmbayes">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">msmbayes</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/advanced.html">Advanced multi-state models in msmbayes</a>
    <a class="dropdown-item" href="../articles/examples.html">Examples of using msmbayes</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Examples of using msmbayes</h1>
                        <h4 data-toc-skip class="author">Christopher
Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk" class="email">chris.jackson@mrc-bsu.cam.ac.uk</a>
</h4>
            
            <h4 data-toc-skip class="date">2024-03-28</h4>
      
      
      <div class="d-none name"><code>examples.Rmd</code></div>
    </div>

    
    
<p>This article demonstrates the basic use of the <code>msmbayes</code>
package to fit Bayesian multi-state models to longitudinal data
consisting of intermittent observations of a state.</p>
<ul>
<li><p>It shows that <code>msmbayes</code> can reproduce the true
parameter values for a simulated dataset, within an expected margin of
simulation error, and gives similar results to
<code>msm</code>.</p></li>
<li><p>It gives some general hints and warnings about Bayesian
implementation of these models, e.g. priors, computational challenges.
However this is the subject of ongoing research, so it is somewhat
vague.</p></li>
</ul>
<p>A general introduction to the theory and practice of multi-state
modelling is given in the documentation and course notes for the <a href="https://chjackson.github.io/msm/" class="external-link"><code>msm</code>
package</a>.</p>
<p><code>msmbayes</code> essentially fits Bayesian versions of some of
the models in <code>msm</code>. However <code>msmbayes</code> has more
limited features - see the front page for a more detailed
comparison.</p>
<div class="section level2">
<h2 id="sec-simdata">Simulated infection testing data<a class="anchor" aria-label="anchor" href="#sec-simdata"></a>
</h2>
<p>These examples all use a simulated dataset designed to mimic a
longitudinal study where people are repeatedly tested for an
infection.</p>
<p>We assume a two-state multi-state model, with states “test positive”
and “test negative”.</p>
<p><img src="examples_files/figure-html/twostate-1.png" width="480"></p>
<p>The data are simulated from a continuous-time Markov model with the
following transition intensity matrix. Expressed in days or months,
respectively, this is</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">msmbayes</span><span class="op">)</span></span>
<span><span class="va">Qtrue</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fl">180</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">180</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">1</span><span class="op">/</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Qtruemo</span> <span class="op">&lt;-</span> <span class="va">Qtrue</span><span class="op">*</span><span class="fl">365</span><span class="op">/</span><span class="fl">12</span></span></code></pre></div>
<p>That is, everyone starts with no infection, then,</p>
<ul>
<li><p>the mean time until the next infection is 180 days (6 months)
(the mean sojourn time in state 1)</p></li>
<li><p>the mean time with infection is 10 days (0.33 months) (the mean
sojourn time in state 2)</p></li>
</ul>
<p>We then suppose that 100 people are tested every 28 days, and assume
the test is a perfect indicator of infection. The final dataset stores
the state at each test time in the variable <code>state</code>.</p>
<p>We also simulate some covariates, including sex and age, and a state
outcome <code>statec</code> which depends on these covariates (see <a href="examples.html#sec-covs">below</a>).</p>
<blockquote>
<p><strong>Note</strong>: age is expressed in units of (years - 50)/10.
Centering around a typical value (50 years), and scaling to a unit of
interest (10 years) will help with both MCMC computation and
interpretation of parameters.</p>
</blockquote>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">infsim</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   subject days months state  sex       age10 statec statep statepc</span></span>
<span><span class="co">## 1       1    0   0.00     1 male -0.31322691      1      1       1</span></span>
<span><span class="co">## 2       1   28   0.92     1 male  0.09182166      2      1       1</span></span>
<span><span class="co">## 3       1   56   1.84     1 male -0.41781431      1      1       1</span></span>
<span><span class="co">## 4       1   84   2.76     1 male  0.79764040      1      1       1</span></span>
<span><span class="co">## 5       1  112   3.68     1 male  0.16475389      2      1       1</span></span>
<span><span class="co">## 6       1  140   4.60     1 male -0.41023419      2      1       2</span></span></code></pre>
<p>We analyse this dataset with continuous-time multistate models, where
we assume transitions between states can happen at any time, and not
just at the observation times. In this demonstration, when we fit the
models, we pretend that we only know the state at the time of each test,
and that we don’t know the true times of infection and recovery. This is
the typical style of data that the <code>msm</code> package is used for
— where the state is only known at a series of arbitrary times.</p>
<blockquote>
<p><strong>Note:</strong> Both <code>msm</code> and
<code>msmbayes</code> allow any number of states and structure of
allowed transitions. This includes models with or without “absorbing”
states, such as death. However, <code>msmbayes</code> has some
limitations, listed on the <a href="../index.html">front page</a>. For
example, the “exact death times” observation scheme (where we suppose
the time of death is known, but the state immediately before death is
unknown) is not supported.</p>
</blockquote>
</div>
<div class="section level2">
<h2 id="fitting-a-basic-markov-model-with-msmbayes">Fitting a basic Markov model with msmbayes<a class="anchor" aria-label="anchor" href="#fitting-a-basic-markov-model-with-msmbayes"></a>
</h2>
<p>First we demonstrate fitting the basic two-state Markov multi-state
model with no covariates. There are two unknown parameters: the
transition intensities between 1-2 and 2-1.</p>
<p>The first argument to <code>msmbayes</code> is the dataset, and
additional named arguments indicate the names of the columns in the data
that contain the state, the time of observation and the subject
(individual) identifier.</p>
<blockquote>
<p><strong>Note:</strong> unlike in <code><a href="https://chjackson.github.io/msm/reference/msm.html" class="external-link">msm()</a></code>, the names of
variables in the data must be quoted as strings, not “bare” variable
names.</p>
</blockquote>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmbayes.html">msmbayes</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">infsim</span>, state<span class="op">=</span><span class="st">"state"</span>, time<span class="op">=</span><span class="st">"months"</span>, subject<span class="op">=</span><span class="st">"subject"</span>,</span>
<span>                  Q<span class="op">=</span><span class="va">Q</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="transition-structure-and-initial-values">Transition structure and initial values<a class="anchor" aria-label="anchor" href="#transition-structure-and-initial-values"></a>
</h4>
<p>The argument <code>Q</code> to <code><a href="../reference/msmbayes.html">msmbayes()</a></code> is a square
matrix that indicates the transition structure. This is in the same
format as <code><a href="https://chjackson.github.io/msm/reference/msm.html" class="external-link">msm()</a></code>:</p>
<ul>
<li><p>The number of rows (or columns) indicates the number of states,
here 2.</p></li>
<li><p>The diagonal of this matrix is ignored - what you specify on the
diagonal doesn’t matter.</p></li>
<li><p>The <strong>off-diagonal</strong> entries of <code>Q</code> which
are <strong>1</strong> indicate the transitions that are allowed in
continuous time (here, state 1 to state 2, and 2 to 1).</p></li>
<li><p>The <strong>off-diagonal</strong> entries of <code>Q</code> which
are <strong>0</strong> indicate the transitions that are not allowed in
continuous time.</p></li>
</ul>
</div>
<div class="section level4">
<h4 id="transition-intensities-and-prior-distributions">Transition intensities and prior distributions<a class="anchor" aria-label="anchor" href="#transition-intensities-and-prior-distributions"></a>
</h4>
<p>The parameters of the model, <span class="math inline">\(q_{rs}\)</span>, are transition intensities in
continuous time. These are not probabilities, but rates. In particular,
they are not probabilities of transition over an interval of time, as in
a discrete-time Markov model. See, e.g. the <a href="https://chjackson.github.io/msm/msmcourse/msmbasic.html#transition-structure-is-for-the-continuous-time-process" class="external-link"><code>msm</code>
course notes</a> for more discussion of this distinction. To interpret
these values, note that <span class="math inline">\(q_{rs}\)</span> is
the rate at which transitions to <span class="math inline">\(s\)</span>
are observed for a population in state <span class="math inline">\(r\)</span>. So <span class="math inline">\(1/q_{rs}\)</span> is the mean time to the next
transition to <span class="math inline">\(s\)</span> that would be
observed in this population.</p>
<p>Additional arguments <code>lqmean</code> and <code>lqsd</code> can be
supplied to <code>msmbayes</code> to specify the mean and standard
deviation of the normal prior for the log transition intensities. Prior
distributions are necessary in a Bayesian model. If not supplied here, a
mean of -2 and a standard deviation of 2 will be used by default. This
implies a 95% credible interval of between <span class="math inline">\(\exp(-6)=0.002\)</span> and <span class="math inline">\(\exp(2)=7\)</span> for the event rate, equivalent
to a mean time to the event (inverting the rates) of between 0.1 and
400. This is appropriately vague in many applications, but a more
thoughtful choice is recommended in practice - note this will depend on
the time unit (e.g. days or months).</p>
</div>
<div class="section level3">
<h3 id="outputs-from-msmbayes">Outputs from msmbayes<a class="anchor" aria-label="anchor" href="#outputs-from-msmbayes"></a>
</h3>
<p>The <code><a href="../reference/msmbayes.html">msmbayes()</a></code> function uses <a href="https://mc-stan.org" class="external-link">Stan</a> to draw a sample from the joint
posterior distribution of the model parameters. By default, MCMC is
used, but faster approximations are available (see <a href="examples.html#sec-comp">below</a>).</p>
<p>This returns an object in the <code>draws</code> format defined by
the <code>posterior</code> R package. This format is understood by
various Bayesian R packages. For example, we can use the
<code>bayesplot</code> package to check that the MCMC chains have
converged, using trace-plots of the main parameters (here the log
transition intensities, labelled <code>logq</code>), and to examine the
posterior distributions. Trace plots should look flat and fuzzy, like a
sequence of independent draws from the same distribution, if the chains
have converged (as here).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot/" class="external-link">bayesplot</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-traces.html" class="external-link">mcmc_trace</a></span><span class="op">(</span><span class="va">draws</span>, pars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logq[1]"</span>,<span class="st">"logq[2]"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-distributions.html" class="external-link">mcmc_dens</a></span><span class="op">(</span><span class="va">draws</span>, pars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logq[1]"</span>,<span class="st">"logq[2]"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-4-2.png" width="700"></p>
<p>To summarise the basic parameter estimates (transition intensities
here) use the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> function. This also gives the
“Rhat” convergence diagnostic, which should be close to 1.0 if the MCMC
estimation has converged (<a href="https://mc-stan.org/rstan/reference/Rhat.html" class="external-link">see here</a> for
more explanation.)</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 5</span></span></span>
<span><span class="co">##   name   from    to        value  rhat</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> q         1     2  0.38 <span style="color: #949494;">± 0.44</span>  1.01</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> q         2     1  7.07 <span style="color: #949494;">± 8.27</span>  1.01</span></span></code></pre>
<p>Transition intensities are hard to interpret in isolation. However we
can obtain from them the mean sojourn times in each state. The mean
sojourn times are estimated to be (within estimation error) close to the
true values of 6 and 0.33 months, as expected.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mean_sojourn.html">mean_sojourn</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 2</span></span></span>
<span><span class="co">##   state         value</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     1  3.96 <span style="color: #949494;">± 1.655</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>     2  0.21 <span style="color: #949494;">± 0.089</span></span></span></code></pre>
<p>See also <code><a href="../reference/qdf.html">qdf()</a></code> to get just the intensities, or
<code><a href="../reference/qmatrix.html">qmatrix()</a></code> for the same quantities in a matrix rather than
data frame format.</p>
<p>The <code>value</code> column of data frames returned by these
functions is of type <code>rvar</code>. This data type is from the
<code>posterior</code> package. It is designed to contain random
variables, such as uncertain quantities in Bayesian models. Instead of a
single value, it stores a sample from the quantity’s distribution. Here
this is the posterior distribution. It is printed here as a posterior
mean <span class="math inline">\(\pm\)</span> one standard
deviation.</p>
<p>The <code>summary</code> function can be used on these data frames to
extract posterior summary statistics from the object in the
<code>value</code> column. With no further arguments, the default
summary statistics from the <code>posterior</code> package will be used.
Or the user can specify their own functions, as in the following call.
See the <code>posterior</code> package <a href="https://mc-stan.org/posterior/reference/draws_summary.html" class="external-link">documentation</a>
for more examples.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/mean_sojourn.html">mean_sojourn</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span>, <span class="va">mean</span>, <span class="va">median</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.x</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   state      mean    median       2.5%     97.5%</span></span>
<span><span class="co">## 1     1 3.9554948 4.2250877 0.62034426 6.6902199</span></span>
<span><span class="co">## 2     2 0.2130968 0.2288359 0.03430154 0.3559479</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="sec-covs">Fitting a Markov model with covariates<a class="anchor" aria-label="anchor" href="#sec-covs"></a>
</h2>
<p>To demonstrate how to fit a Markov multi-state model with covariates,
some data are simulated from a model with covariates.</p>
<p>The variable <code>statec</code> in the <code>infsim</code> data is
simulated from a continuous-time Markov model with intensities <span class="math inline">\(q_{rsi} = q_{rs}^{(0)} \exp(\beta_{rs}^{(male)}
male_i + \beta_{rs}^{(age)} age_i)\)</span>, where <span class="math inline">\(i\)</span> is an individual, <span class="math inline">\(male_i\)</span> is a binary indicator of whether
they are male, and <span class="math inline">\(age_i\)</span> is their
age. The log hazard ratios for the effects of covariates on the 1-2
transition are <span class="math inline">\((\beta_{12}^{(male)},
\beta_{12}^{(age)}) = (2,1)\)</span>, and for the 2-1 transition, <span class="math inline">\((\beta_{21}^{(male)}, \beta_{21}^{(age)}) =
(0,-1)\)</span>.</p>
<p><span class="math inline">\(q_{rs}^{(0)}\)</span> is the intensity
for a “reference” or baseline individual, defined as a 50 year old
woman. The same values as <a href="#sec-simdata">above</a> are used for
this. In the data <code>infsim</code>, age is expressed in units of 10
years, and centered around age 50. Centering around a value of interest
helps with interpretation of the intercept term <span class="math inline">\(q_{rs}^{(0)}\)</span>. Centering and scaling
covariates to a roughly unit scale also tends to help with computation,
especially for MCMC.</p>
<p>To include covariates in a <code>msmbayes</code> model, a
<code>covariates</code> argument is included. The following model
assumes sex and age are predictors of both the 1-2 and 2-1 transition
intensities.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmbayes.html">msmbayes</a></span><span class="op">(</span><span class="va">infsim</span>, state<span class="op">=</span><span class="st">"statec"</span>, time<span class="op">=</span><span class="st">"months"</span>, subject<span class="op">=</span><span class="st">"subject"</span>,</span>
<span>                  Q<span class="op">=</span><span class="va">Q</span>,  covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu">Q</span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">~</span><span class="va">sex</span><span class="op">+</span><span class="va">age10</span>, <span class="fu">Q</span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">~</span><span class="va">sex</span><span class="op">+</span><span class="va">age10</span><span class="op">)</span>,</span>
<span>                  fit_method<span class="op">=</span><span class="st">"pathfinder"</span>,</span>
<span>                  betamean<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, betasd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The syntax of the <code>covariates</code> argument is a list of
formulae. Each formula has</p>
<ul>
<li><p>a left-hand side that looks like <code>Q(r,s)</code> indicating
which <span class="math inline">\(r \rightarrow s\)</span> transition
intensity is the outcome,</p></li>
<li><p>a right-hand side giving the predictors as a linear model
formula.</p></li>
</ul>
<p>For example, <code>Q(2,1) ~ sex + age</code> indicates that <span class="math inline">\(\log(q_{21})\)</span> is an additive linear
function of age and sex.</p>
<blockquote>
<p><strong>Note:</strong> This syntax is slightly different from
<code>msm</code>, where we would use a named list of formulae with empty
“outcome” left-hand sides,
e.g. <code>covariates = list("1-2" = ~sex+age, "2-1" = ~ sex+age)</code>.</p>
</blockquote>
<p>After fitting a <code>msmbayes</code> model with covariates, the
<code>summary</code> function on the model object returns the estimates
of the baseline intensities <span class="math inline">\(q_{rs}^{(0)}\)</span> and the log hazard ratios
<span class="math inline">\(\beta_{rs}\)</span>, indicated here by
covariate name and transition.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">##   name     from    to          value  rhat</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> q           1     2   0.16 <span style="color: #949494;">± 0.032</span> 1.00 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> q           2     1   2.77 <span style="color: #949494;">± 0.486</span> 0.999</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> sexmale     1     2   3.18 <span style="color: #949494;">± 0.772</span> 0.999</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> age10       1     2   1.11 <span style="color: #949494;">± 0.281</span> 0.999</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> sexmale     2     1   1.26 <span style="color: #949494;">± 0.785</span> 0.999</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> age10       2     1  -0.76 <span style="color: #949494;">± 0.265</span> 1.00</span></span></code></pre>
<p>The estimates of the log hazard ratios are close to the true values
of 2, 1, 0, and -1 used to simulate the data, within estimation
error.</p>
<p>The function <code>hr</code> can be used to summarise the hazard
ratios <span class="math inline">\(\exp(\beta_{rs})\)</span>. Note the
posterior distributions are skewed, hence the posterior mean of the
hazard ratio is different from the <span class="math inline">\(\exp()\)</span> of the posterior mean of the log
hazard ratio. The mode or median may be preferred as a point
estimate.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/hr.html">hr</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span>   </span></code></pre></div>
<pre><code><span><span class="co">##   from to    name         value</span></span>
<span><span class="co">## 1    1  2 sexmale 33.13 ± 31.46</span></span>
<span><span class="co">## 2    1  2   age10  3.17 ± 0.90 </span></span>
<span><span class="co">## 3    2  1 sexmale  4.94 ± 4.83 </span></span>
<span><span class="co">## 4    2  1   age10  0.48 ± 0.13</span></span></code></pre>
<div class="section level3">
<h3 id="sec-comp">Notes on computation and tuning<a class="anchor" aria-label="anchor" href="#sec-comp"></a>
</h3>
<ul>
<li><p>Normal priors for the <code>beta</code> can be specified with the
<code>betamean</code> and <code>betasd</code> arguments. Careful of
these. Bear in mind the likely size of covariate effects when choosing
the prior variance. Make sure the prior represents any evidence about
the effect that exists outside the data.</p></li>
<li>
<p>The <code>fit_method</code> argument specifies the quoted name of
a function in <code>cmdstanr</code> to be used to do the sampling. <a href="https://mc-stan.org/cmdstanr/reference/model-method-sample.html" class="external-link">“sample”</a>
is the default. Users can pass arguments to these functions in to
<code>msmbayes</code> to control sampling, e.g. initial values, parallel
processing…</p>
<ul>
<li><p><code>fit_method="laplace"</code> uses a <a href="https://mc-stan.org/cmdstanr/reference/model-method-laplace.html" class="external-link">Laplace
approximation</a> which determines the posterior mode exactly, then uses
a normal approximation to the distribution around this mode. MCMC
reveals some skewed posterior distributions in this case, so the Laplace
approximation is not ideal. However, it is much faster than
MCMC.</p></li>
<li><p><code>fit_method="pathfinder"</code> implements a <a href="https://mc-stan.org/cmdstanr/reference/model-method-pathfinder.html" class="external-link">variational
approximation to the posterior</a>. This is designed to be better than
Laplace, and better than the standard variational method. It runs much
faster than MCMC in this case, and is used in the example
above.</p></li>
<li><p><code>fit_method="variational"</code> runs quickly, similar to
the Laplace method, but seems to give less nuanced posterior
distributions than the Pathfinder method.</p></li>
</ul>
</li>
<li><p>This example works with Stan’s default MCMC initial values, which
are sampled from the priors. Users could also supply the
<code>init</code> argument to <code>msmbayes</code>, which is passed to
Stan.</p></li>
<li><p>If the model fits the data badly, then the sampling may be bad
with any method.</p></li>
<li><p>Sampling can also be bad when covariate values are on different
scales. Centering and scaling is usually sensible, as
mentioned.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="comparison-between-a-bayesian-and-a-frequentist-multistate-model">Comparison between a Bayesian and a frequentist multistate
model<a class="anchor" aria-label="anchor" href="#comparison-between-a-bayesian-and-a-frequentist-multistate-model"></a>
</h3>
<p>Compare with the same model fitted in the <code>msm</code> package by
maximum likelihood. Awkwardly, the optimiser used by <code>msm</code>
needs to be tuned (with the <code>fnscale</code> option) to find the
global optimum.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/msm" class="external-link">msm</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://chjackson.github.io/msm/reference/msm.html" class="external-link">msm</a></span><span class="op">(</span><span class="va">statec</span><span class="op">~</span><span class="va">months</span>, subject<span class="op">=</span><span class="va">subject</span>, data<span class="op">=</span><span class="va">infsim</span>, qmatrix<span class="op">=</span><span class="va">Q</span>, </span>
<span>    covariates<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"1-2"</span><span class="op">=</span><span class="op">~</span><span class="va">sex</span><span class="op">+</span><span class="va">age10</span>, <span class="st">"2-1"</span><span class="op">=</span><span class="op">~</span><span class="va">sex</span><span class="op">+</span><span class="va">age10</span><span class="op">)</span>,</span>
<span>    control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fnscale<span class="op">=</span><span class="fl">1000</span>, maxit<span class="op">=</span><span class="fl">10000</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## msm(formula = statec ~ months, subject = subject, data = infsim,     qmatrix = Q, covariates = list(`1-2` = ~sex + age10, `2-1` = ~sex +         age10), control = list(fnscale = 1000, maxit = 10000))</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Maximum likelihood estimates</span></span>
<span><span class="co">## Baselines are with covariates set to their means</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Transition intensities with hazard ratios for each covariate</span></span>
<span><span class="co">##                   Baseline                   sexmale              </span></span>
<span><span class="co">## State 1 - State 1 -0.6362 ( -2.5591,-0.1582)                      </span></span>
<span><span class="co">## State 1 - State 2  0.6362 (  0.1582, 2.5591) 16.567 (1.0309,266.2)</span></span>
<span><span class="co">## State 2 - State 1  4.2780 (  1.0667,17.1572)  2.401 (0.1497, 38.5)</span></span>
<span><span class="co">## State 2 - State 2 -4.2780 (-17.1572,-1.0667)                      </span></span>
<span><span class="co">##                   age10                 </span></span>
<span><span class="co">## State 1 - State 1                       </span></span>
<span><span class="co">## State 1 - State 2 3.0433 (1.5766,5.8745)</span></span>
<span><span class="co">## State 2 - State 1 0.4748 (0.2441,0.9235)</span></span>
<span><span class="co">## State 2 - State 2                       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## -2 * log-likelihood:  2717.274</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 7.3890561 2.7182818 1.0000000 0.3678794</span></span></code></pre>
<p>The estimates of the hazard ratios (note, not the log hazard ratios
here) are within estimation error of the true values, but they differ
from those of the Bayesian model, due to the influence of the prior
distributions. This shows that the information from the data is not
strong enough to overcome the influence of the prior, and suggests that
priors should be thoughtfully chosen and transparently communicated if
this were a real example.</p>
<p>One common problem with multi-state models for
intermittently-observed data is that the likelihood surface is awkwardly
shaped. When using <code>msm</code>, this can lead to the optimiser
appearing to “converge”, but to a local optimum, or “saddle point”,
rather than the true global maximum of the likelihood. Symptoms of this
problem may include very large confidence intervals (which happens here
if <code>fnscale</code> is not set), or a warning related to the Hessian
matrix being non-invertible. More seriously, there may be convergence to
the wrong optimum but with no obvious symptoms - this can only be
detected by running the optimiser many times with different initial
values.</p>
<p>An advantage of the Bayesian estimation methods used here is that
after sampling, we can see the full shape of the posterior distribution.
In this example, the posterior is skewed for all the model parameters,
and there is evidence that it may be “multimodal”, i.e. has several
peaks.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-distributions.html" class="external-link">mcmc_dens</a></span><span class="op">(</span><span class="va">draws</span>, pars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logq[1]"</span>,<span class="st">"logq[2]"</span>,<span class="st">"beta[1]"</span>,<span class="st">"beta[2]"</span>,<span class="st">"beta[3]"</span>,<span class="st">"beta[4]"</span><span class="op">)</span>,</span>
<span>          adjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="phase-type-semi-markov-models-and-misclassification-models">Phase-type semi-Markov models, and misclassification models<a class="anchor" aria-label="anchor" href="#phase-type-semi-markov-models-and-misclassification-models"></a>
</h2>
<p>See the vignette about <a href="advanced.html">advanced multi-state
models</a> in <code>msmbayes</code>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
