<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Examples of using msmbayes • msmbayes</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Examples of using msmbayes">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">msmbayes</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/examples.html">Examples of using msmbayes</a>
    </li>
    <li>
      <a href="../articles/misclass.html">Misclassification multi-state models in msmbayes</a>
    </li>
    <li>
      <a href="../articles/semimarkov.html">Semi-Markov models with msmbayes</a>
    </li>
    <li>
      <a href="../articles/nphase.html">Advanced phase-type models in msmbayes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/chjackson/msmbayes/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Examples of using msmbayes</h1>
                        <h4 data-toc-skip class="author">Christopher
Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk" class="email">chris.jackson@mrc-bsu.cam.ac.uk</a>
</h4>
            
            <h4 data-toc-skip class="date">2025-01-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/chjackson/msmbayes/blob/HEAD/vignettes/examples.Rmd" class="external-link"><code>vignettes/examples.Rmd</code></a></small>
      <div class="hidden name"><code>examples.Rmd</code></div>

    </div>

    
    
<p>This article demonstrates the basic use of the <code>msmbayes</code>
package to fit Bayesian multi-state models to longitudinal data
consisting of intermittent observations of a state.</p>
<ul>
<li><p>It shows that <code>msmbayes</code> can reproduce the true
parameter values for a simulated dataset, within an expected margin of
simulation error, and gives similar results to
<code>msm</code>.</p></li>
<li><p>It gives some general hints and warnings about Bayesian
implementation of these models, e.g. priors, computational challenges.
Though this is the subject of ongoing research.</p></li>
</ul>
<p>A general introduction to the theory and practice of multi-state
modelling is given in the documentation and course notes for the <a href="https://chjackson.github.io/msm/" class="external-link"><code>msm</code>
package</a>.</p>
<p><code>msmbayes</code> essentially fits Bayesian versions of some of
the models in <code>msm</code>. However <code>msmbayes</code> has more
limited features - see the front page for a more detailed
comparison.</p>
<div class="section level2">
<h2 id="sec-simdata">Simulated infection testing data<a class="anchor" aria-label="anchor" href="#sec-simdata"></a>
</h2>
<p>These examples all use a simulated dataset designed to mimic a
longitudinal study where people are repeatedly tested for an
infection.</p>
<p>We assume a two-state multi-state model, with states “test positive”
and “test negative”.</p>
<p><img src="../reference/figures/twostate.png" alt="A two-state Markov model" width="400px"></p>
<p>The data are simulated from a continuous-time Markov model with the
following transition intensity matrix. Expressed in days or months,
respectively, this is</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/msmbayes" class="external-link">msmbayes</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in get(paste0(generic, ".", class), envir = get_method_env()) : </span></span>
<span><span class="co">##   object 'type_sum.accel' not found</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Qtrue</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fl">180</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">180</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">1</span><span class="op">/</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Qtruemo</span> <span class="op">&lt;-</span> <span class="va">Qtrue</span><span class="op">*</span><span class="fl">365</span><span class="op">/</span><span class="fl">12</span></span></code></pre></div>
<p>That is, everyone starts with no infection, then,</p>
<ul>
<li><p>the mean time until the next infection is 180 days (6 months)
(the mean sojourn time in state 1)</p></li>
<li><p>the mean time with infection is 10 days (0.33 months) (the mean
sojourn time in state 2)</p></li>
</ul>
<p>We then suppose that 100 people are tested every 28 days, and assume
the test is a perfect indicator of infection. The final dataset stores
the state at each test time in the variable <code>state</code>.</p>
<p>We also simulate some covariates, including sex and age, and a state
outcome <code>statec</code> which depends on these covariates (see <a href="examples.html#sec-covs">below</a>).</p>
<blockquote>
<p><strong>Note</strong>: age is expressed in units of (years - 50)/10.
Centering around a typical value (50 years), and scaling to a unit of
interest (10 years) will help with both MCMC computation and
interpretation of parameters.</p>
</blockquote>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">infsim</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   subject days months state  sex       age10 statec statep statepc</span></span>
<span><span class="co">## 1       1    0   0.00     1 male -0.31322691      1      1       1</span></span>
<span><span class="co">## 2       1   28   0.92     1 male  0.09182166      2      1       1</span></span>
<span><span class="co">## 3       1   56   1.84     1 male -0.41781431      1      1       1</span></span>
<span><span class="co">## 4       1   84   2.76     1 male  0.79764040      1      1       2</span></span>
<span><span class="co">## 5       1  112   3.68     1 male  0.16475389      2      1       2</span></span>
<span><span class="co">## 6       1  140   4.60     1 male -0.41023419      2      1       2</span></span></code></pre>
<p>We analyse this dataset with continuous-time multistate models, where
we assume transitions between states can happen at any time, and not
just at the observation times. In this demonstration, when we fit the
models, we pretend that we only know the state at the time of each test,
and that we don’t know the true times of infection and recovery. This is
the typical style of data that the <code>msm</code> package is used for
— where the state is only known at a series of arbitrary times.</p>
<blockquote>
<p><strong>Note:</strong> Both <code>msm</code> and
<code>msmbayes</code> allow any number of states and structure of
allowed transitions. This includes models with or without “absorbing”
states, such as death. However, <code>msmbayes</code> has some
limitations, listed on the <a href="../index.html">front page</a>. For
example, the “exact death times” observation scheme (where we suppose
the time of death is known, but the state immediately before death is
unknown) is not supported.</p>
</blockquote>
</div>
<div class="section level2">
<h2 id="fitting-a-basic-markov-model-with-msmbayes">Fitting a basic Markov model with msmbayes<a class="anchor" aria-label="anchor" href="#fitting-a-basic-markov-model-with-msmbayes"></a>
</h2>
<p>First we demonstrate fitting the basic two-state Markov multi-state
model with no covariates. There are two unknown parameters: the
transition intensities between 1-2 and 2-1.</p>
<p>The first argument to <code>msmbayes</code> is the dataset, and
additional named arguments indicate the names of the columns in the data
that contain the state, the time of observation and the subject
(individual) identifier.</p>
<blockquote>
<p><strong>Note:</strong> unlike in <code><a href="https://chjackson.github.io/msm/reference/msm.html" class="external-link">msm()</a></code>, the names of
variables in the data must be quoted as strings, not “bare” variable
names.</p>
</blockquote>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmbayes.html">msmbayes</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">infsim</span>, state<span class="op">=</span><span class="st">"state"</span>, time<span class="op">=</span><span class="st">"months"</span>, subject<span class="op">=</span><span class="st">"subject"</span>,</span>
<span>                  Q<span class="op">=</span><span class="va">Q</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">## Running the chains for more iterations may help. See</span></span>
<span><span class="co">## https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre>
<div class="section level4">
<h4 id="transition-structure">Transition structure<a class="anchor" aria-label="anchor" href="#transition-structure"></a>
</h4>
<p>The argument <code>Q</code> to <code><a href="../reference/msmbayes.html">msmbayes()</a></code> is a square
matrix that indicates the transition structure. This is in the same
format as <code><a href="https://chjackson.github.io/msm/reference/msm.html" class="external-link">msm()</a></code>:</p>
<ul>
<li><p>The number of rows (or columns) indicates the number of states,
here 2.</p></li>
<li><p>The diagonal of this matrix is ignored - what you specify on the
diagonal doesn’t matter.</p></li>
<li><p>The <strong>off-diagonal</strong> entries of <code>Q</code> which
are <strong>1</strong> indicate the transitions that are allowed in
continuous time (here, state 1 to state 2, and 2 to 1).</p></li>
<li><p>The <strong>off-diagonal</strong> entries of <code>Q</code> which
are <strong>0</strong> indicate the transitions that are not allowed in
continuous time (here, all transitions are allowed).</p></li>
</ul>
</div>
<div class="section level4">
<h4 id="sec-priors">Prior distributions for transition intensities<a class="anchor" aria-label="anchor" href="#sec-priors"></a>
</h4>
<p>The parameters of the model,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow></msub><annotation encoding="application/x-tex">q_{rs}</annotation></semantics></math>,
are transition intensities in continuous time. These are not
probabilities, but rates. In particular, they are not probabilities of
transition over an interval of time, as in a discrete-time Markov model.
See, e.g. the <a href="https://chjackson.github.io/msm/msmcourse/msmbasic.html#transition-structure-is-for-the-continuous-time-process" class="external-link"><code>msm</code>
course notes</a> for more discussion of this distinction.</p>
<p>To interpret these values, note that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow></msub><annotation encoding="application/x-tex">q_{rs}</annotation></semantics></math>
is the rate at which transitions to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>
are observed for a population in state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>.
So
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi>/</mi><msub><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">1/q_{rs}</annotation></semantics></math>
is the mean time to the next transition to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>
that would be observed in a population in state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>,
if we were to observe one person at a time (switching to observing a
different person if a “competing event”, i.e. a transition to a state
other than
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>,
happens). Or put more simply perhaps, the mean time from state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>
if there were no competing events.</p>
<p>In a Bayesian model, prior distributions must be defined for all
parameters. In <code>msmbayes</code>, normal priors are used for the log
transition intensities. The mean and standard deviation of these priors
can be set through the <code>priors</code> argument to the
<code>msmbayes</code> function. This is a list of objects created by the
function <code>msmprior</code>. These objects can be specified in
various alternative ways:</p>
<ol style="list-style-type: lower-alpha">
<li>
<p>Directly specifying the mean and standard deviation for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(q_{rs})</annotation></semantics></math>,
e.g.:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/msmprior.html">msmprior</a></span><span class="op">(</span><span class="st">"logq(1,2)"</span>, mean<span class="op">=</span><span class="op">-</span><span class="fl">1</span>, sd<span class="op">=</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/msmprior.html">msmprior</a></span><span class="op">(</span><span class="st">"logq(2,1)"</span>, mean<span class="op">=</span><span class="op">-</span><span class="fl">1</span>, sd<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p>Specifying prior quantiles for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(q_{rs})</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow></msub><annotation encoding="application/x-tex">q_{rs}</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi>/</mi><msub><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">1/q_{rs}</annotation></semantics></math>:</p>
<p>We can specify two out of the <code>median</code> (i.e. 50%
quantile), the <code>lower</code> 95% quantile or the <code>upper</code>
95% quantile for any of these quantities. Perhaps the easiest to
interpret is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi>/</mi><msub><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">1/q_{rs}</annotation></semantics></math>,
the mean time to event
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>
for people in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>,
supplied here as <code>time(r,s)</code>. Only two quantiles should be
provided for each parameter, because this allows a unique normal
distribution on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(q_{rs})</annotation></semantics></math>
to be deduced. Different specifications can be mixed for different
parameters, e.g. </p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/msmprior.html">msmprior</a></span><span class="op">(</span><span class="st">"q(2,1)"</span>,    lower<span class="op">=</span><span class="fl">0.001</span>, upper<span class="op">=</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/msmprior.html">msmprior</a></span><span class="op">(</span><span class="st">"time(1,2)"</span>, median<span class="op">=</span><span class="fl">10</span>, upper<span class="op">=</span><span class="fl">30</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</li>
</ol>
<blockquote>
<p><strong>Note:</strong> the prior represents a belief about the
<em>average in a population</em> - not a distribution for individual
outcomes. Here, it means that we expect the average time from state 1 to
state 2 (over a population) is 10 months, but this average could be as
high as 30. We are not saying that we expect to see <em>individual</em>
times to events of up to 30.</p>
</blockquote>
<ol start="3" style="list-style-type: lower-alpha">
<li>
<p>Accept the defaults.</p>
<p>For any parameters not supplied in the <code>priors</code> argument,
a normal distribution with a mean of -2 and a standard deviation of 2
will be used for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(q_{rs})</annotation></semantics></math>.
This implies a 95% credible interval of between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>−</mi><mn>6</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>0.002</mn></mrow><annotation encoding="application/x-tex">\exp(-6)=0.002</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>7</mn></mrow><annotation encoding="application/x-tex">\exp(2)=7</annotation></semantics></math>
for the event rate, equivalent to a mean time to event of between 0.1
and 400. This is appropriately vague in many applications, but a more
thoughtful choice is recommended in practice. Note the prior depends on
the time unit (e.g. days or months).</p>
</li>
</ol>
<p>The object <code>priors</code> is supplied as the <code>priors</code>
argument to <code>msmbayes</code>, e.g. </p>
<pre><code><span><span class="fu"><a href="../reference/msmbayes.html">msmbayes</a></span><span class="op">(</span><span class="va">...</span>, priors<span class="op">=</span><span class="va">priors</span>,<span class="va">...</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="outputs-from-msmbayes">Outputs from msmbayes<a class="anchor" aria-label="anchor" href="#outputs-from-msmbayes"></a>
</h3>
<p>The <code><a href="../reference/msmbayes.html">msmbayes()</a></code> function uses <a href="https://mc-stan.org" class="external-link">Stan</a> to draw a sample from the joint
posterior distribution of the model parameters. By default, MCMC is
used, but faster approximations are available (see <a href="examples.html#sec-comp">below</a>).</p>
<p><code><a href="../reference/msmbayes.html">msmbayes()</a></code> returns an object in the <code>draws</code>
format defined by the <code>posterior</code> R package. This format is
understood by various Bayesian R packages. For example, we can use the
<code>bayesplot</code> package to check that the MCMC chains have
converged, using trace-plots of the main parameters (here the log
transition intensities, labelled <code>logq</code>), and to examine the
posterior distributions. Trace plots should look horizontal and fuzzy,
like a sequence of independent draws from the same distribution, if the
chains have converged (as here).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot/" class="external-link">bayesplot</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-traces.html" class="external-link">mcmc_trace</a></span><span class="op">(</span><span class="va">draws</span>, pars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logq[1]"</span>,<span class="st">"logq[2]"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-distributions.html" class="external-link">mcmc_dens</a></span><span class="op">(</span><span class="va">draws</span>, pars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logq[1]"</span>,<span class="st">"logq[2]"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-7-2.png" width="700"></p>
<p>The <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> function can be used to summarise the
basic parameter estimates (transition intensities here). This gives a
summary of the posterior for each parameter (variable
<code>value</code>), alongside a summary of the prior for that
parameter. Since transition intensities are hard to interpret in
isolation, the mean sojourn times in each state are included alongside,
labelled <code>mst</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 4 × 5</span></span></span>
<span><span class="co">##   name   from    to         value  rhat</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> q         1     2  0.16 <span style="color: #949494;">± 0.063</span>  1.01</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> q         2     1  3.53 <span style="color: #949494;">± 1.390</span>  1.01</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> mst       1    <span style="color: #BB0000;">NA</span>  6.68 <span style="color: #949494;">± 1.420</span>  1.01</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> mst       2    <span style="color: #BB0000;">NA</span>  0.30 <span style="color: #949494;">± 0.063</span>  1.01</span></span></code></pre>
<p>The mean sojourn times are estimated to be (within estimation error)
close to the true values of 6 and 0.33 months, as expected.</p>
<p>Set <code>time=TRUE</code> to summarise the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi>/</mi><msub><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">1/q_{rs}</annotation></semantics></math>
(mean times to event, ignoring competing events, as described above) and
their priors. If there are no competing risks, as here, these are equal
to the mean sojourn times. Or set <code>log=TRUE</code> to summarise the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(q_{rs})</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">draws</span>, time<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 4 × 5</span></span></span>
<span><span class="co">##   name   from    to        value  rhat</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> time      1     2  6.7 <span style="color: #949494;">± 1.420</span>  1.01</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> time      2     1  0.3 <span style="color: #949494;">± 0.063</span>  1.01</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> mst       1    <span style="color: #BB0000;">NA</span>  6.7 <span style="color: #949494;">± 1.420</span>  1.01</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> mst       2    <span style="color: #BB0000;">NA</span>  0.3 <span style="color: #949494;">± 0.063</span>  1.01</span></span></code></pre>
<p>The <code>summary</code> output also gives the “Rhat” convergence
diagnostic, which should be close to 1.0 if the MCMC estimation has
converged (<a href="https://mc-stan.org/rstan/reference/Rhat.html" class="external-link">see
here</a> for more explanation.)</p>
<p>See also <code><a href="../reference/qdf.html">qdf()</a></code> to get just the intensities, or
<code><a href="../reference/qmatrix.html">qmatrix()</a></code> for the same quantities in a matrix rather than
data frame format, and <code><a href="../reference/mean_sojourn.html">mean_sojourn()</a></code> to get just the mean
sojourn times.</p>
<p>The <code>value</code> column of data frames returned by these
functions is of type <code>rvar</code>. This data type is from the
<code>posterior</code> package. It is designed to contain random
variables, such as uncertain quantities in Bayesian models. Instead of a
single value, it stores a sample from the quantity’s distribution. Here
this is the posterior distribution. It is printed here as a posterior
mean
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>±</mi><annotation encoding="application/x-tex">\pm</annotation></semantics></math>
one standard deviation.</p>
<p>To extract specific posterior summary statistics, the
<code>summary</code> function can be used on any of these data
frames.</p>
<p>With no further arguments, the default summary statistics from the
<code>posterior</code> package will be used. Or the user can specify
their own functions, as in the following call. See the
<code>posterior</code> package <a href="https://mc-stan.org/posterior/reference/draws_summary.html" class="external-link">documentation</a>
for more examples.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/mean_sojourn.html">mean_sojourn</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span>, <span class="va">mean</span>, <span class="va">median</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   state     mean    median      2.5%    97.5%</span></span>
<span><span class="co">## 1     1 6.683310 6.7464642 3.4533375 9.269407</span></span>
<span><span class="co">## 2     2 0.303457 0.3088913 0.1570317 0.416692</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="sec-covs">Fitting a Markov model with covariates<a class="anchor" aria-label="anchor" href="#sec-covs"></a>
</h2>
<p>To demonstrate how to fit a Markov multi-state model with covariates,
some data are simulated from a model with covariates.</p>
<p>The variable <code>statec</code> in the <code>infsim</code> data is
simulated from a continuous-time Markov model with intensities
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mrow><mi>r</mi><mi>s</mi><mi>i</mi></mrow></msub><mo>=</mo><msubsup><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>β</mi><mrow><mi>r</mi><mi>s</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>m</mi><mi>a</mi><mi>l</mi><mi>e</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mi>m</mi><mi>a</mi><mi>l</mi><msub><mi>e</mi><mi>i</mi></msub><mo>+</mo><msubsup><mi>β</mi><mrow><mi>r</mi><mi>s</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mi>g</mi><mi>e</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mi>a</mi><mi>g</mi><msub><mi>e</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">q_{rsi} = q_{rs}^{(0)} \exp(\beta_{rs}^{(male)} male_i + \beta_{rs}^{(age)} age_i)</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
is an individual,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>a</mi><mi>l</mi><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">male_i</annotation></semantics></math>
is a binary indicator of whether they are male, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>g</mi><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">age_i</annotation></semantics></math>
is their age. The log hazard ratios for the effects of covariates on the
1-2 transition are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>β</mi><mn>12</mn><mrow><mo stretchy="true" form="prefix">(</mo><mi>m</mi><mi>a</mi><mi>l</mi><mi>e</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mo>,</mo><msubsup><mi>β</mi><mn>12</mn><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mi>g</mi><mi>e</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">(\beta_{12}^{(male)}, \beta_{12}^{(age)}) = (2,1)</annotation></semantics></math>,
and for the 2-1 transition,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>β</mi><mn>21</mn><mrow><mo stretchy="true" form="prefix">(</mo><mi>m</mi><mi>a</mi><mi>l</mi><mi>e</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mo>,</mo><msubsup><mi>β</mi><mn>21</mn><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mi>g</mi><mi>e</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mi>−</mi><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">(\beta_{21}^{(male)}, \beta_{21}^{(age)}) = (0,-1)</annotation></semantics></math>.</p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><annotation encoding="application/x-tex">q_{rs}^{(0)}</annotation></semantics></math>
is the intensity for a “reference” or baseline individual, defined as a
50 year old woman. The same values as <a href="#sec-simdata">above</a>
are used for this. In the data <code>infsim</code>, age is expressed in
units of 10 years, and centered around age 50. Centering around a value
of interest helps with interpretation of the intercept term
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><annotation encoding="application/x-tex">q_{rs}^{(0)}</annotation></semantics></math>.
Centering and scaling covariates to a roughly unit scale also tends to
help with computation, especially for MCMC.</p>
<p>To include covariates in a <code>msmbayes</code> model, a
<code>covariates</code> argument is included. The following model
supposes that sex and age are predictors of both the 1-2 and 2-1
transition intensities. Weakly informative priors are defined for the
covariate effects, through specifying upper 95% credible limits of 50
for the hazard ratios.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/msmprior.html">msmprior</a></span><span class="op">(</span><span class="st">"hr(age10,1,2)"</span>,median<span class="op">=</span><span class="fl">1</span>,upper<span class="op">=</span><span class="fl">50</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="../reference/msmprior.html">msmprior</a></span><span class="op">(</span><span class="st">"hr(age10,2,1)"</span>,median<span class="op">=</span><span class="fl">1</span>,upper<span class="op">=</span><span class="fl">50</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="../reference/msmprior.html">msmprior</a></span><span class="op">(</span><span class="st">"hr(sexmale,1,2)"</span>,median<span class="op">=</span><span class="fl">1</span>,upper<span class="op">=</span><span class="fl">50</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="../reference/msmprior.html">msmprior</a></span><span class="op">(</span><span class="st">"hr(sexmale,2,1)"</span>,median<span class="op">=</span><span class="fl">1</span>,upper<span class="op">=</span><span class="fl">50</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmbayes.html">msmbayes</a></span><span class="op">(</span><span class="va">infsim</span>, state<span class="op">=</span><span class="st">"statec"</span>, time<span class="op">=</span><span class="st">"months"</span>, subject<span class="op">=</span><span class="st">"subject"</span>,</span>
<span>                  Q<span class="op">=</span><span class="va">Q</span>,  covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu">Q</span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">~</span><span class="va">sex</span><span class="op">+</span><span class="va">age10</span>, <span class="fu">Q</span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">~</span><span class="va">sex</span><span class="op">+</span><span class="va">age10</span><span class="op">)</span>,</span>
<span>                  fit_method<span class="op">=</span><span class="st">"optimize"</span>,</span>
<span>                  priors <span class="op">=</span> <span class="va">priors</span><span class="op">)</span></span></code></pre></div>
<p>The syntax of the <code>covariates</code> argument is a list of
formulae. Each formula has</p>
<ul>
<li><p>a left-hand side that looks like <code>Q(r,s)</code> indicating
which
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>→</mo><mi>s</mi></mrow><annotation encoding="application/x-tex">r \rightarrow s</annotation></semantics></math>
transition intensity is the outcome,</p></li>
<li><p>a right-hand side giving the predictors as a linear model
formula.</p></li>
</ul>
<p>For example, <code>Q(2,1) ~ sex + age</code> indicates that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>q</mi><mn>21</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(q_{21})</annotation></semantics></math>
is an additive linear function of age and sex.</p>
<blockquote>
<p><strong>Note:</strong> This syntax is slightly different from
<code>msm</code>, where we would use a named list of formulae with empty
“outcome” left-hand sides,
e.g. <code>covariates = list("1-2" = ~sex+age, "2-1" = ~ sex+age)</code>.</p>
</blockquote>
<p>After fitting a <code>msmbayes</code> model with covariates, the
<code>summary</code> function on the model object returns the estimates
of the baseline intensities
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>q</mi><mrow><mi>r</mi><mi>s</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><annotation encoding="application/x-tex">q_{rs}^{(0)}</annotation></semantics></math>
and the hazard ratios
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>β</mi><mrow><mi>r</mi><mi>s</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">exp(\beta_{rs})</annotation></semantics></math>,
indicated here by covariate name and transition.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 8 × 5</span></span></span>
<span><span class="co">##   name         from    to         value  rhat</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> q               1     2  0.21 <span style="color: #949494;">± 0.084</span>  1.00</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> q               2     1  4.67 <span style="color: #949494;">± 1.904</span>  1.00</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> mst             1    <span style="color: #BB0000;">NA</span>  5.59 <span style="color: #949494;">± 2.257</span>  1.00</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> mst             2    <span style="color: #BB0000;">NA</span>  0.25 <span style="color: #949494;">± 0.101</span>  1.00</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> hr(sexmale)     1     2  5.74 <span style="color: #949494;">± 2.315</span>  1.00</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> hr(age10)       1     2  3.19 <span style="color: #949494;">± 1.587</span>  1.00</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">7</span> hr(sexmale)     2     1  0.62 <span style="color: #949494;">± 0.264</span>  1.00</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">8</span> hr(age10)       2     1  0.38 <span style="color: #949494;">± 0.205</span>  1.00</span></span></code></pre>
<p>The functions <code>loghr</code> or <code>hr</code> can be used to
summarise the log hazard ratios or hazard ratios in isolation. The
estimates of the log hazard ratios are close to the true values of 2, 1,
0, and -1 used to simulate the data, within estimation error.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loghr.html">loghr</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span>   </span></code></pre></div>
<pre><code><span><span class="co">##   from to    name        value</span></span>
<span><span class="co">## 1    1  2 sexmale  1.67 ± 0.39</span></span>
<span><span class="co">## 2    1  2   age10  1.05 ± 0.47</span></span>
<span><span class="co">## 3    2  1 sexmale -0.57 ± 0.41</span></span>
<span><span class="co">## 4    2  1   age10 -1.11 ± 0.51</span></span></code></pre>
<p>Note the posterior distributions are skewed, hence the posterior mean
of the hazard ratio is different from the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\exp()</annotation></semantics></math>
of the posterior mean of the log hazard ratio. The mode or median may be
preferred as a point estimate.</p>
<div class="section level3">
<h3 id="sec-priors-cov">Priors on covariate effects<a class="anchor" aria-label="anchor" href="#sec-priors-cov"></a>
</h3>
<p>Normal priors are used for the log hazard ratios
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>.
These can be specified through the <code>priors</code> argument, as
above, either by specifying the mean and SD for the log hazard ratios,
or quantiles of either the hazard ratios or the log hazard ratios. Note
the specific covariate should be referred to as well as the transition.
For example, to define priors for the effect of age on the 1-2 and 2-1
transition rates respectively:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/msmprior.html">msmprior</a></span><span class="op">(</span><span class="st">"loghr(age,1,2)"</span>, mean<span class="op">=</span><span class="fl">0</span>,   sd<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="../reference/msmprior.html">msmprior</a></span><span class="op">(</span><span class="st">"hr(age,2,1)"</span>,    median<span class="op">=</span><span class="fl">1</span>, upper<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>For factor covariates, the appropriate factor level should be
included in the name (as done for <code>sexmale</code> above).</p>
<p>For any priors for log hazard ratios not specified through
<code>priors</code>, a default normal prior with mean 0 and SD 10 is
used. Be careful of this prior choice. Bear in mind the likely size of
covariate effects when choosing the prior variance. Make sure the prior
represents any evidence about the effect that exists outside the
data.</p>
</div>
<div class="section level3">
<h3 id="sec-comp">Notes on computation and tuning<a class="anchor" aria-label="anchor" href="#sec-comp"></a>
</h3>
<ul>
<li>
<p>The <code>fit_method</code> argument specifies the algorithm used
to fit the Bayesian model. <code>"sample"</code> is the default, which
uses the standard Hamiltonian MCMC algorithm, via the function <a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">rstan::sampling</a>.
Users can pass arguments to this functions through <code>msmbayes</code>
to control sampling, e.g. initial values, parallel processing.</p>
<ul>
<li><p><code>fit_method="optimize"</code> uses the function <a href="https://mc-stan.org/rstan/reference/stanmodel-method-optimizing.html" class="external-link">rstan::optimizing</a>
which determines the posterior mode exactly for the parameters on their
real-line scales (e.g. log intensities, log hazard ratios), then uses a
normal (Laplace) approximation to the distribution around this mode.
MCMC reveals some skewed posterior distributions in this case, so this
approximation is not ideal. However, it is much faster than
MCMC.</p></li>
<li><p>Variational Bayes methods are also available, via
<code>fit_method="vb"</code> which calls <a href="https://mc-stan.org/rstan/reference/stanmodel-method-vb.html" class="external-link">rstan::vb</a>,
and <code>fit_method="pathfinder"</code> which calls the more advanced
<a href="https://mc-stan.org/cmdstanr/reference/model-method-pathfinder.html" class="external-link">Pathfinder
method</a>. The Pathfinder method requires <code>cmdstanr</code> and
<code>cmdstan</code> to be installed manually. These methods are
designed to be much faster than MCMC and approximate the posterior in a
slightly more sophisticated way than the Laplace method. If the
approximation is poor, then a warning message referring to the “Pareto k
value” will be printed when the model is fitted.</p></li>
</ul>
</li>
<li><p>This example works with Stan’s default MCMC initial values, which
are sampled from the priors. Users could also supply the
<code>init</code> argument to <code>msmbayes</code>, which is passed to
Stan.</p></li>
<li><p>If the model fits the data badly, then the sampling may be bad
with any method.</p></li>
<li><p>Sampling can also be bad when covariate values are on different
scales. Centering and scaling is usually sensible, as
mentioned.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="comparison-between-a-bayesian-and-a-frequentist-multistate-model">Comparison between a Bayesian and a frequentist multistate
model<a class="anchor" aria-label="anchor" href="#comparison-between-a-bayesian-and-a-frequentist-multistate-model"></a>
</h3>
<p>Compare with the same model fitted in the <code>msm</code> package by
maximum likelihood. Awkwardly, the optimiser used by <code>msm</code>
needs to be tuned (with the <code>fnscale</code> option) to find the
global optimum.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/msm" class="external-link">msm</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: package 'msm' was built under R version 4.4.2</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://chjackson.github.io/msm/reference/msm.html" class="external-link">msm</a></span><span class="op">(</span><span class="va">statec</span><span class="op">~</span><span class="va">months</span>, subject <span class="op">=</span> <span class="va">subject</span>, data <span class="op">=</span> <span class="va">infsim</span>, qmatrix <span class="op">=</span> <span class="va">Q</span>, </span>
<span>    covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"1-2"</span> <span class="op">=</span> <span class="op">~</span><span class="va">sex</span><span class="op">+</span><span class="va">age10</span>, <span class="st">"2-1"</span> <span class="op">=</span> <span class="op">~</span><span class="va">sex</span><span class="op">+</span><span class="va">age10</span><span class="op">)</span>,</span>
<span>    control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fnscale<span class="op">=</span><span class="fl">1000</span>, maxit<span class="op">=</span><span class="fl">10000</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## msm(formula = statec ~ months, subject = subject, data = infsim,     qmatrix = Q, covariates = list(`1-2` = ~sex + age10, `2-1` = ~sex +         age10), control = list(fnscale = 1000, maxit = 10000))</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Maximum likelihood estimates</span></span>
<span><span class="co">## Baselines are with covariates set to their means</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Transition intensities with hazard ratios for each covariate</span></span>
<span><span class="co">##                   Baseline                  sexmale               </span></span>
<span><span class="co">## State 1 - State 1 -0.5114 (-1.2556,-0.2083)                       </span></span>
<span><span class="co">## State 1 - State 2  0.5114 ( 0.2083, 1.2556) 4.5467 (1.5166,13.631)</span></span>
<span><span class="co">## State 2 - State 1  3.7258 ( 1.5021, 9.2415) 0.4722 (0.1407, 1.585)</span></span>
<span><span class="co">## State 2 - State 2 -3.7258 (-9.2415,-1.5021)                       </span></span>
<span><span class="co">##                   age10                 </span></span>
<span><span class="co">## State 1 - State 1                       </span></span>
<span><span class="co">## State 1 - State 2 2.3576 (0.68633,8.099)</span></span>
<span><span class="co">## State 2 - State 1 0.2687 (0.07144,1.011)</span></span>
<span><span class="co">## State 2 - State 2                       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## -2 * log-likelihood:  2625.65</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 7.3890561 2.7182818 1.0000000 0.3678794</span></span></code></pre>
<p>The estimates of the hazard ratios (note, not the log hazard ratios
here) are within estimation error of the true values, but they differ
from those of the Bayesian model, due to the influence of the prior
distributions. This shows that the information from the data is not
strong enough to overcome the influence of the prior, and suggests that
priors should be thoughtfully chosen and transparently communicated if
this were a real example.</p>
<p>One common problem with multi-state models for
intermittently-observed data is that the likelihood surface is awkwardly
shaped. When using <code>msm</code>, this can lead to the optimiser
appearing to “converge”, but to a local optimum, or “saddle point”,
rather than the true global maximum of the likelihood. Symptoms of this
problem may include very large confidence intervals (which happens here
if <code>fnscale</code> is not set), or a warning related to the Hessian
matrix being non-invertible. More seriously, there may be convergence to
the wrong optimum but with no obvious symptoms - this can only be
detected by running the optimiser many times with different initial
values.</p>
<p>An advantage of the Bayesian estimation methods used here is that
after sampling, we can see the full shape of the posterior distribution.
In this example, if we had used MCMC (<code>fit_method="sample"</code>
rather than <code>fit_method="optimize"</code>), we could observe that
the true (non-approximated) posterior is skewed for all the model
parameters, and may be “multimodal”, i.e. has several peaks. Though that
would be much slower to run.</p>
</div>
</div>
<div class="section level2">
<h2 id="more-advanced-multi-state-models-in-msmbayes">More advanced multi-state models in <code>msmbayes</code><a class="anchor" aria-label="anchor" href="#more-advanced-multi-state-models-in-msmbayes"></a>
</h2>
<p>See the separate vignettes for</p>
<ul>
<li><p><a href="misclass.html">Misclassification multi-state
models</a></p></li>
<li><p><a href="semimarkov.html">Semi-Markov models using phase-type
approximations</a></p></li>
<li><p><a href="nphase.html">General phase-type semi-Markov
models</a></p></li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
