<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="msmbayes">
<title>Advanced multi-state models in msmbayes • msmbayes</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced multi-state models in msmbayes">
<meta property="og:description" content="msmbayes">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">msmbayes</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/advanced.html">Advanced multi-state models in msmbayes</a>
    <a class="dropdown-item" href="../articles/examples.html">Examples of using msmbayes</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/chjackson/msmbayes/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Advanced multi-state models in msmbayes</h1>
                        <h4 data-toc-skip class="author">Christopher
Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk" class="email">chris.jackson@mrc-bsu.cam.ac.uk</a>
</h4>
            
            <h4 data-toc-skip class="date">2024-04-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/chjackson/msmbayes/blob/HEAD/vignettes/advanced.Rmd" class="external-link"><code>vignettes/advanced.Rmd</code></a></small>
      <div class="d-none name"><code>advanced.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="phase-type-semi-markov-models">Phase-type semi-Markov models<a class="anchor" aria-label="anchor" href="#phase-type-semi-markov-models"></a>
</h2>
<p>In a multi-state model, suppose we do not believe the sojourn time in
a particular state follows an exponential distribution. For example, in
the infection model, suppose we do not believe that the time spent in
the “test positive” state is exponential.</p>
<p><img src="../reference/figures/twostate.png" width="500px"></p>
<p>We can relax this assumption by building a
<strong>“semi-Markov”</strong> model, where the sojourn time in this
state follows a more complex distribution. One way to do this is to
replace this state by a series of two (or more) latent or hidden states,
known as “phases”. For example, with two phases:</p>
<p><img src="../reference/figures/twostatephase.png" width="600px"></p>
<blockquote>
<p>In a phase-type model, we allow progression from one phase to the
next, but not transitions from later to earlier phases (or jumps between
non-adjacent phases, if there are 3 phases or more). Otherwise, we allow
the same transitions out of each phase as were allowed in the original
model (to state 1, in this example)</p>
</blockquote>
<p>We then assume transitions between and out of the phases follow
exponential distributions. That is, we assume a Markov model on the
latent state space. The test-positive state then has a sojourn
distribution known as the <a href="https://en.wikipedia.org/wiki/Phase-type_distribution#Coxian_distribution" class="external-link">“Coxian”
phase-type</a> distribution, instead of the exponential.</p>
<blockquote>
<p><strong>Note</strong>: This is an example of a <strong>hidden Markov
model</strong>, though one of a specific form where some states are
observed correctly, and some states are latent. Phase-type models are a
convenient way to build semi-Markov models for intermittently-observed
data, because there are standard algorithms for computing the likelihood
of a hidden Markov model.</p>
</blockquote>
</div>
<div class="section level2">
<h2 id="fitting-phase-type-models-in-msmbayes">Fitting phase-type models in msmbayes<a class="anchor" aria-label="anchor" href="#fitting-phase-type-models-in-msmbayes"></a>
</h2>
<p>To assume a phase-type sojourn distribution for one or more states in
a <code>msmbayes</code> model, set the <code>nphase</code> argument.
This is a vector of length equal to the number of states, giving the
number of phases per state. Any elements of <code>nphase</code> that are
1 correspond to states with the usual exponential sojourn
distribution.</p>
<div class="section level3">
<h3 id="example-data-simulated-from-a-standard-markov-model">Example: data simulated from a standard Markov model<a class="anchor" aria-label="anchor" href="#example-data-simulated-from-a-standard-markov-model"></a>
</h3>
<p>Here we extend the 2-state model for the simulated infection data to
give state 2 (infection) a two-phase sojourn distribution. These data
were originally simulated assuming an exponential sojourn distribution
in state 2 (with rate 3). In this situation, we would expect the
estimated rates of transition out of each phase to be identical.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/msmbayes" class="external-link">msmbayes</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmbayes.html">msmbayes</a></span><span class="op">(</span><span class="va">infsim2</span>, state<span class="op">=</span><span class="st">"state"</span>, time<span class="op">=</span><span class="st">"months"</span>, subject<span class="op">=</span><span class="st">"subject"</span>,</span>
<span>                  Q<span class="op">=</span><span class="va">Q</span>, nphase<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 7 × 6</span></span></span>
<span><span class="co">##   name  from  to             value prior               rhat</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> q     1     2p1     0.99 <span style="color: #949494;">± 0.94</span>  0.14 (0.0027, 6.7)  1.00</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> q     2p1   1       5.28 <span style="color: #949494;">± 6.17</span>  0.14 (0.0027, 6.7)  1.00</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> q     2p1   2p2     2.67 <span style="color: #949494;">± 27.31</span> 0.14 (0.0027, 6.7)  1.00</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> q     2p2   1       4.56 <span style="color: #949494;">± 15.89</span> 0.14 (0.0027, 6.7)  1.00</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> mst   1     <span style="color: #BB0000;">NA</span>      1.45 <span style="color: #949494;">± 0.71</span>  7.4 (0.148, 369)    1.00</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> mst   2p1   <span style="color: #BB0000;">NA</span>      0.21 <span style="color: #949494;">± 0.11</span>  3.7 (0.074, 184)    1.00</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">7</span> mst   2p2   <span style="color: #BB0000;">NA</span>     17.63 <span style="color: #949494;">± 95.37</span> 7.4 (0.148, 369)    1.00</span></span></code></pre>
<p>The phased states are labelled specially here, e.g. the first phase
of state 2 is labelled <code>"2p1"</code>. The estimated transition
rates from the two phases of state 2 to state 1 are not significantly
different from 2 - but there is large uncertainty around the estimated
rates, since this model is over-fitted to the data. Implementing the
same model in <code>msm</code> would give extremely large confidence
intervals around the estimated rates.</p>
</div>
<div class="section level3">
<h3 id="example-data-simulated-from-a-phase-type-model">Example: data simulated from a phase-type model<a class="anchor" aria-label="anchor" href="#example-data-simulated-from-a-phase-type-model"></a>
</h3>
<p>The following code simulates a dataset from the following phase-type
model structure</p>
<p><img src="../reference/figures/threestatephase.png" width="600px"></p>
<p>with a transition intensity matrix (on the latent state space) given
in the R object <code>Qg</code>. This code uses the ability of the
function <code><a href="https://chjackson.github.io/msm/reference/simmulti.msm.html" class="external-link">simmulti.msm()</a></code> from the <code>msm</code> package
to simulate from hidden Markov models.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Qg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.18</span>, <span class="fl">0.008</span>, <span class="fl">0.012</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>,    <span class="fl">0.016</span>, <span class="fl">0.024</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>,    <span class="fl">0</span>,     <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>,    <span class="fl">0</span>,     <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">E</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, <span class="co"># hidden Markov model misclassification matrix</span></span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nsubj</span> <span class="op">&lt;-</span> <span class="fl">10000</span>; <span class="va">nobspt</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">sim.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>subject <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nsubj</span>, each<span class="op">=</span><span class="va">nobspt</span><span class="op">)</span>,</span>
<span>                     time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, length<span class="op">=</span><span class="va">nobspt</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/msm" class="external-link">msm</a></span><span class="op">)</span></span>
<span><span class="va">sim.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://chjackson.github.io/msm/reference/simmulti.msm.html" class="external-link">simmulti.msm</a></span><span class="op">(</span><span class="va">sim.df</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, qmatrix<span class="op">=</span><span class="va">Qg</span>, ematrix<span class="op">=</span><span class="va">E</span><span class="op">)</span></span></code></pre></div>
<p>We fit the phase-type model to the simulated data using both
<code>msmbayes</code> and <code>msm</code>.</p>
<p>The <code>"pathfinder"</code> variational inference algorithm is used
to approximate the Bayesian posterior. There are some warning messages
from using this algorithm in this example, so in practice we might have
wanted to cross-check the results with MCMC.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Q3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmbayes.html">msmbayes</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">sim.df</span>, state<span class="op">=</span><span class="st">"obs"</span>, time<span class="op">=</span><span class="st">"time"</span>, subject<span class="op">=</span><span class="st">"subject"</span>,</span>
<span>                  Q<span class="op">=</span><span class="va">Q3</span>, nphase<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, fit_method<span class="op">=</span><span class="st">"pathfinder"</span><span class="op">)</span></span>
<span><span class="fu">bayesplot</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-distributions.html" class="external-link">mcmc_dens</a></span><span class="op">(</span><span class="va">draws</span>, pars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"logq[%s]"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>The posterior distribution appears awkwardly shaped, with evidence of
several local maxima or “saddle points”.</p>
<p><code>msm</code> needs some tuning to converge, in particular the use
of <code>fnscale</code> and explicit initial values for the transition
rate. In practice, sensitivity analysis to these initial values would be
needed to confirm that the reported estimates are the global maximum
likelihood estimates, rather than one of the local maxima or saddle
points.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Q3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0.5</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">s.msm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://chjackson.github.io/msm/reference/msm.html" class="external-link">msm</a></span><span class="op">(</span><span class="va">obs</span> <span class="op">~</span> <span class="va">time</span>, subject<span class="op">=</span><span class="va">subject</span>, data<span class="op">=</span><span class="va">sim.df</span>, phase.states<span class="op">=</span><span class="fl">1</span>, qmatrix<span class="op">=</span><span class="va">Q3</span>,</span>
<span>             phase.inits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>trans<span class="op">=</span><span class="fl">0.05</span>,  <span class="co"># seems to need these</span></span>
<span>                                   exit<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.05</span>,<span class="fl">4</span><span class="op">)</span>,nrow<span class="op">=</span><span class="fl">2</span>,byrow<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>trace<span class="op">=</span><span class="fl">1</span>,REPORT<span class="op">=</span><span class="fl">1</span>,fnscale<span class="op">=</span><span class="fl">50000</span>,maxit<span class="op">=</span><span class="fl">10000</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Reassuringly, the Bayesian and frequentist methods give similar
estimates of the transition intensities, which agree (within estimation
error) with the values used for simulation.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/qmatrix.html">qmatrix</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## rvar&lt;1000&gt;[4,4] <span style="color: #949494;">mean ± sd:</span></span></span>
<span><span class="co">##      [,1]               [,2]               [,3]              </span></span>
<span><span class="co">## [1,] -0.1800 ± 0.02771   0.1721 ± 0.02971   0.0048 ± 0.00261 </span></span>
<span><span class="co">## [2,]  0.0000 ± 0.00000  -0.0393 ± 0.00061   0.0160 ± 0.00057 </span></span>
<span><span class="co">## [3,]  0.0000 ± 0.00000   0.0000 ± 0.00000  -0.2006 ± 0.00578 </span></span>
<span><span class="co">## [4,]  0.0000 ± 0.00000   0.0000 ± 0.00000   0.0000 ± 0.00000 </span></span>
<span><span class="co">##      [,4]              </span></span>
<span><span class="co">## [1,]  0.0030 ± 0.00197 </span></span>
<span><span class="co">## [2,]  0.0233 ± 0.00058 </span></span>
<span><span class="co">## [3,]  0.2006 ± 0.00578 </span></span>
<span><span class="co">## [4,]  0.0000 ± 0.00000</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://chjackson.github.io/msm/reference/qmatrix.msm.html" class="external-link">qmatrix.msm</a></span><span class="op">(</span><span class="va">s.msm</span>,ci<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              State 1 [P1] State 1 [P2]     State 2    State 3</span></span>
<span><span class="co">## State 1 [P1]   -0.1986608   0.17706760  0.01059025 0.01100295</span></span>
<span><span class="co">## State 1 [P2]    0.0000000  -0.03930873  0.01593401 0.02337472</span></span>
<span><span class="co">## State 2         0.0000000   0.00000000 -0.20150880 0.20150880</span></span>
<span><span class="co">## State 3         0.0000000   0.00000000  0.00000000 0.00000000</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Qg</span></span></code></pre></div>
<pre><code><span><span class="co">##      [,1] [,2]  [,3]  [,4]</span></span>
<span><span class="co">## [1,]    0 0.18 0.008 0.012</span></span>
<span><span class="co">## [2,]    0 0.00 0.016 0.024</span></span>
<span><span class="co">## [3,]    0 0.00 0.000 0.200</span></span>
<span><span class="co">## [4,]    0 0.00 0.000 0.000</span></span></code></pre>
<p>The mean sojourn times in states of a phase-type model can either be
calculated for the latent state space (<code>by_phase=TRUE</code>, the
default), or the observable state space
(<code>by_phase=FALSE</code>).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mean_sojourn.html">mean_sojourn</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 2</span></span></span>
<span><span class="co">##   state        value</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> 1p1     5.7 <span style="color: #949494;">± 0.89</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> 1p2    25.4 <span style="color: #949494;">± 0.39</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> 2       5.0 <span style="color: #949494;">± 0.14</span></span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mean_sojourn.html">mean_sojourn</a></span><span class="op">(</span><span class="va">draws</span>, by_phase<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 2</span></span></span>
<span><span class="co">##   state       value</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     1   30 <span style="color: #949494;">± 0.38</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>     2    5 <span style="color: #949494;">± 0.14</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>     3  Inf <span style="color: #949494;">± NaN</span></span></span></code></pre>
<p>More practical experience of using these phase-type models is needed.
In particular:</p>
<ul>
<li><p>How to specify substantive prior information. In the examples
above, the default log-normal(-2,2) priors were used for transition
intensities. But we need a better way to choose these based on
judgements about interpretable quantities, e.g. the mean sojourn time in
the phased state.</p></li>
<li><p>Limited experience suggests that the Bayesian method is more
likely than <code>msm</code> to produce a plausible result without the
need for tuning. However, can the sampling algorithms always be relied
upon?</p></li>
<li><p>How to build and interpret models with covariates on intensities.
Covariates can be placed on intensities for transitions in the phased
state-space, but this has not been tested in practice. There is a risk
of over-fitting, and strong constraints on covariate effects are
expected to be necessary.</p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="multi-state-models-with-misclassification">Multi-state models with misclassification<a class="anchor" aria-label="anchor" href="#multi-state-models-with-misclassification"></a>
</h2>
<p>Another application of hidden Markov models is to account for
misclassification of states in a multi-state model.</p>
<p>To fit a misclassification multi-state models in
<code>msmbayes</code>, the structure of allowed misclassifications is
supplied in the <code>E</code> argument (the “e” stands for “emission”).
This is a matrix with off-diagonal entries:</p>
<ul>
<li><p>1 if true state [row number] can be misclassified as [column
number]</p></li>
<li><p>0 if true state [row number] cannot be misclassified as [column
number]</p></li>
</ul>
<p>The diagonal entries of <code>E</code> are ignored (as for the
<code>Q</code> argument).</p>
<p>The following example is discussed in the <a href="https://cran.r-project.org/web/packages/msm/vignettes/msm-manual.pdf" class="external-link"><code>msm</code>
user guide</a> (Section 2.14). We model progression between three states
of CAV (a disease experienced by heart transplant recipients), and allow
death from any of these states. True state 1 can be misclassified as 2,
true state 2 can be misclassified as 1 or 3, and true state 3 can be
misclassified as 2.</p>
<p>For speed in this demo, we use Stan’s <code>"optimize"</code> method,
which simply determines the posterior mode, and no other posterior
summaries.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Qcav</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Ecav</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmbayes.html">msmbayes</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cav</span>, state<span class="op">=</span><span class="st">"state"</span>, time<span class="op">=</span><span class="st">"years"</span>, subject<span class="op">=</span><span class="st">"PTNUM"</span>, </span>
<span>                  Q<span class="op">=</span><span class="va">Qcav</span>, E<span class="op">=</span><span class="va">Ecav</span>, fit_method<span class="op">=</span><span class="st">"optimize"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/qmatrix.html">qmatrix</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## rvar&lt;1&gt;[4,4] <span style="color: #949494;">mean ± sd:</span></span></span>
<span><span class="co">##      [,1]         [,2]         [,3]         [,4]        </span></span>
<span><span class="co">## [1,] -0.145 ± NA   0.099 ± NA   0.000 ± NA   0.047 ± NA </span></span>
<span><span class="co">## [2,]  0.000 ± NA  -0.263 ± NA   0.200 ± NA   0.064 ± NA </span></span>
<span><span class="co">## [3,]  0.000 ± NA   0.000 ± NA  -0.364 ± NA   0.364 ± NA </span></span>
<span><span class="co">## [4,]  0.000 ± NA   0.000 ± NA   0.000 ± NA   0.000 ± NA</span></span></code></pre>
<p>The function <code>edf</code> extracts the misclassification (or
“emission”) probabilities in a tidy data frame form.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/edf.html">edf</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 4 × 3</span></span></span>
<span><span class="co">##    from    to        value</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     1     2  0.0081 <span style="color: #949494;">± NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>     2     1  0.2380 <span style="color: #949494;">± NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>     2     3  0.0513 <span style="color: #949494;">± NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span>     3     2  0.1120 <span style="color: #949494;">± NA</span></span></span></code></pre>
<p>An identical non-Bayesian model is fitted using
<code><a href="https://chjackson.github.io/msm/reference/msm.html" class="external-link">msm()</a></code>.</p>
<blockquote>
<p><strong>Note</strong>: this is different from the model fitted in the
<code>msm</code> manual, since “exact death times” are not supported in
<code>msmbayes</code>. Also note that <code>msm</code> requires
informative initial values for the non-zero intensities and
misclassification probabilities here. For hidden Markov models,
<code>msm</code> is not smart enough to determine good initial values
automatically given the transition structure.</p>
</blockquote>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Qcav</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.148</span>, <span class="fl">0</span>, <span class="fl">0.0171</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.202</span>, <span class="fl">0.081</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.126</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Ecav</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0</span>, <span class="fl">0.1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cav.msm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://chjackson.github.io/msm/reference/msm.html" class="external-link">msm</a></span><span class="op">(</span><span class="va">state</span> <span class="op">~</span> <span class="va">years</span>, subject<span class="op">=</span><span class="va">PTNUM</span>, data<span class="op">=</span><span class="va">cav</span>, qmatrix<span class="op">=</span><span class="va">Qcav</span>, ematrix<span class="op">=</span><span class="va">Ecav</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://chjackson.github.io/msm/reference/qmatrix.msm.html" class="external-link">qmatrix.msm</a></span><span class="op">(</span><span class="va">cav.msm</span>, ci<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            State 1     State 2    State 3    State 4</span></span>
<span><span class="co">## State 1 -0.1452746  0.09855669  0.0000000 0.04671790</span></span>
<span><span class="co">## State 2  0.0000000 -0.26352026  0.2013230 0.06219724</span></span>
<span><span class="co">## State 3  0.0000000  0.00000000 -0.3671024 0.36710242</span></span>
<span><span class="co">## State 4  0.0000000  0.00000000  0.0000000 0.00000000</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://chjackson.github.io/msm/reference/ematrix.msm.html" class="external-link">ematrix.msm</a></span><span class="op">(</span><span class="va">cav.msm</span>, ci<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           State 1     State 2    State 3 State 4</span></span>
<span><span class="co">## State 1 0.9919222 0.008077811 0.00000000       0</span></span>
<span><span class="co">## State 2 0.2379674 0.710858571 0.05117404       0</span></span>
<span><span class="co">## State 3 0.0000000 0.112813389 0.88718661       0</span></span>
<span><span class="co">## State 4 0.0000000 0.000000000 0.00000000       1</span></span></code></pre>
<p>The parameter estimates from <code>msm</code> are close to those from
<code>msmbayes</code>, with any differences explainable by the influence
of the weak prior.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
