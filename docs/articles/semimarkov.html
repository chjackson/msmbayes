<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Semi-Markov models with msmbayes • msmbayes</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Semi-Markov models with msmbayes">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">msmbayes</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/examples.html">Examples of using msmbayes</a></li>
    <li><a class="dropdown-item" href="../articles/misclass.html">Misclassification multi-state models in msmbayes</a></li>
    <li><a class="dropdown-item" href="../articles/semimarkov.html">Semi-Markov models with msmbayes</a></li>
    <li><a class="dropdown-item" href="../articles/nphase.html">Advanced phase-type models in msmbayes</a></li>
    <li><a class="dropdown-item" href="../articles/cognitive.html">Code for using the msmbayes package for semi-Markov modelling in an application to cognitive function</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/chjackson/msmbayes/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Semi-Markov models with msmbayes</h1>
                        <h4 data-toc-skip class="author">Christopher
Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk" class="email">chris.jackson@mrc-bsu.cam.ac.uk</a>
</h4>
            
            <h4 data-toc-skip class="date">2025-08-28</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/chjackson/msmbayes/blob/HEAD/vignettes/semimarkov.Rmd" class="external-link"><code>vignettes/semimarkov.Rmd</code></a></small>
      <div class="d-none name"><code>semimarkov.Rmd</code></div>
    </div>

    
    
<p>Non-Markov models have previously been difficult for intermittently
observed data, since we do not know the times of entry to the states.
For some transition structures, we may not even know whether or not any
particular transition took place within an interval between
observations. Hence it can be hard to discern how the hazard of
transition out of a state depends on the time spent in that state.</p>
<p><code>msmbayes</code> makes these models easier to use. It can fit
multi-state models where the sojourn distribution in any state has a
special two-parameter distribution. This relaxes the Markov assumption,
producing a semi-Markov model, where the transition rate out of a state
depends on how long the individual has spent in the state. The sojourn
distribution used for these models is a <em>phase-type approximation to
a shape-scale distribution</em>, The phase-type approximation idea was
introduced by <a href="https://doi.org/10.1007/s11222-012-9360-6" class="external-link">Titman, 2014</a>.
<code>msmbayes</code> introduces an easier way to obtain the
approximation, and makes these models accessible for the first time.
Full details will be given in a forthcoming paper.</p>
<p><code>msmbayes</code> can also fit phase-type models directly - see
<a href="nphase.html">a separate vignette</a> about these.
<code>msm</code> can also do this with two-phase models. However these
are awkward to use in practice for intermittently observed data. They
have several parameters, which are hard to interpret, and computation
tends to suffer from poor identifiability. By contrast, phase-type
approximations to shape-scale distributions have only two parameters,
and are based on well-understood parametric distributions.</p>
<div class="section level2">
<h2 id="phase-type-shape-scale-distributions">Phase-type shape-scale distributions<a class="anchor" aria-label="anchor" href="#phase-type-shape-scale-distributions"></a>
</h2>
<p>The distribution has two parameters: shape <span class="math inline">\(a\)</span> and scale <span class="math inline">\(b\)</span>. The probability distribution function
is defined by</p>
<p><span class="math display">\[ F(x | a, b) = F_p(x |
\boldsymbol{\lambda}  = b \mathbf{h}(a)) \]</span></p>
<p>where <span class="math inline">\(F_p(x |
\boldsymbol{\lambda})\)</span> is a phase-type distribution (with 5
phases by default) and vector of transition rates <span class="math inline">\(\boldsymbol{\lambda}\)</span>. The shape and scale
are mapped to the phase-type transition rates through a function <span class="math inline">\(\mathbf{h}()\)</span>, determined so that the
first three moments of the phase-type distribution are the same as those
of the Weibull or a Gamma, for a wide range of shape parameters. This
function is pre-determined (using the formulae from <a href="https://doi.org/10.1081/STM-200056210" class="external-link">Bobbio et al.</a>) and
stored in the <code>msmbayes</code> package. A default of 5 phases is
used. This process will be described more formally in a forthcoming
paper, but for now, the code is in the package source
(<code>phaseapprox</code> branch).</p>
<ul>
<li><p>Covariates can be applied to the scale parameter <span class="math inline">\(b\)</span>, as a linear model on <span class="math inline">\(\log(b)\)</span>, giving an accelerated failure
time model.</p></li>
<li><p>Additional assumptions are needed if there are multiple
alternative states <span class="math inline">\(s\)</span> that an
individual can transition to immediately on leaving a state <span class="math inline">\(r\)</span> that has a phase-type approximation. In
<code>msmbayes</code>, this transition is governed by a constant “next
state” probability <span class="math inline">\(\pi_{rs}\)</span>, as is
done in <a href="https://doi.org/10.1007/s11222-012-9360-6" class="external-link">Titman,
2014</a>. This assumes that the transition probability does not depend
on the length of time spent in state <span class="math inline">\(r\)</span> (the supplementary material to <a href="https://doi.org/10.1007/s11222-012-9360-6" class="external-link">Titman, 2014</a>
discusses more flexible alternatives).</p></li>
<li><p>Covariates can also be applied to <span class="math inline">\(\pi_{rs}\)</span> via a multiplicative model on
the odds of transition.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="implementation-in-msmbayes">Implementation in msmbayes<a class="anchor" aria-label="anchor" href="#implementation-in-msmbayes"></a>
</h2>
<p>This vignette gives a demonstration of using semi-Markov models with
phase-type shape-scale distributions in <code>msmbayes</code>, based on
an artificial dataset.</p>
<blockquote>
<p><strong>Note:</strong> this vignette should not be used literally as
a step-by-step recipe for an applied analysis. It is intended to
demonstrate the range of functions available in the package and how to
use them. An applied analysis should take account of the research
question, including thoughtful choice of priors, computing appropriate
outputs of interest, model checking and comparison.</p>
</blockquote>
<div class="section level3">
<h3 id="specifying-a-basic-semi-markov-model">Specifying a basic semi-Markov model<a class="anchor" aria-label="anchor" href="#specifying-a-basic-semi-markov-model"></a>
</h3>
<p>To specify the states given a semi-Markov model, specify the
<code>pastates</code> argument to <code>msmbayes</code>, say
<code>pastates=2</code> if this is state 2, or
<code>pastates=c(1,2)</code> if both states 1 and 2 are semi-Markov.</p>
<p>To start with, we fit a two-state infection model to the basic data
<code>infsim2</code> from the <a href="examples.html">Examples</a>
vignette. This is now made into a semi-Markov model. We compare a model
with the default Gamma approximation (in both states) to a model with a
Weibull for both states (setting the <code>pafamily</code>
argument).</p>
<blockquote>
<p>If there is more than one state given a semi-Markov model, different
distributions can be used for different states, e.g
<code>pastates=c(1,2), pafamily=c("weibull","gamma")</code>.</p>
</blockquote>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/msmbayes" class="external-link">msmbayes</a></span><span class="op">)</span></span>
<span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">drawsg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmbayes.html">msmbayes</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">infsim2</span>, state<span class="op">=</span><span class="st">"state"</span>, time<span class="op">=</span><span class="st">"months"</span>, subject<span class="op">=</span><span class="st">"subject"</span>,</span>
<span>                   pastates<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,</span>
<span>                   Q<span class="op">=</span><span class="va">Q</span>, fit_method<span class="op">=</span><span class="st">"optimize"</span><span class="op">)</span></span>
<span><span class="va">drawsw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmbayes.html">msmbayes</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">infsim2</span>, state<span class="op">=</span><span class="st">"state"</span>, time<span class="op">=</span><span class="st">"months"</span>, subject<span class="op">=</span><span class="st">"subject"</span>,</span>
<span>                   pastates<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, pafamily<span class="op">=</span><span class="st">"weibull"</span>,</span>
<span>                   Q<span class="op">=</span><span class="va">Q</span>, fit_method<span class="op">=</span><span class="st">"optimize"</span><span class="op">)</span></span></code></pre></div>
<p>In this vignette, the Bayesian models are all fitted using posterior
mode optimisation and Laplace approximation (MCMC would be safer -
avoiding the risk of finding a local optimum or mis-estimating
uncertainty - but a lot slower).</p>
<div class="section level4">
<h4 id="summarising-shape-parameters">Summarising shape parameters<a class="anchor" aria-label="anchor" href="#summarising-shape-parameters"></a>
</h4>
<p>Shape parameters around 1.0 (exponential distribution) are supported
for both states 1 and 2, indicating no evidence that the model is
semi-Markov. Indeed, the data were simulated with exponential sojourn
distributions.</p>
<p>Note that the <code>summary</code> method for <code>msmbayes</code>
objects compares the posterior distribution with the prior. The prior is
summarised as a string displaying the median and 95% credible interval,
or an <code>rvar</code> object containing a full posterior sample. See
the <a href="examples.html#rvar">main msmbayes vignette</a> for an
explanation of the <code>rvar</code> format used in the column
“posterior” and how to summarise it.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">drawsg</span>, pars<span class="op">=</span><span class="st">"shape"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">##   name  from    posterior  mode prior_string          prior</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> shape 1      1.1 <span style="color: #949494;">± 0.38</span>  1.02 1.0 (0.38, 2.66)  1.1 <span style="color: #949494;">± 0.6</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> shape 2      1.0 <span style="color: #949494;">± 0.12</span>  1.00 1.0 (0.38, 2.66)  1.1 <span style="color: #949494;">± 0.6</span></span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">drawsw</span>, pars<span class="op">=</span><span class="st">"shape"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">##   name  from    posterior  mode prior_string          prior</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> shape 1      1.0 <span style="color: #949494;">± 0.18</span>  1.04 1.0 (0.61, 1.63)   1 <span style="color: #949494;">± 0.26</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> shape 2      1.1 <span style="color: #949494;">± 0.25</span>  1.13 1.0 (0.61, 1.63)   1 <span style="color: #949494;">± 0.26</span></span></span></code></pre>
</div>
<div class="section level4">
<h4 id="choice-of-priors">Choice of priors<a class="anchor" aria-label="anchor" href="#choice-of-priors"></a>
</h4>
<p>When fitting these models, we used the default prior distributions.
For the shape parameters, the defaults are chosen to give flexible and
numerically stable model families based on the Weibull and Gamma. For
example, the default SD of the Weibull distribution was chosen to rule
out values for the shape parameter lower than about 0.6, for which the
phase-type approximation deviates from the Weibull and becomes
increasingly unstable as the shape decreases.</p>
<p>In a real application, instead of accepting the defaults, a better
approach to specifying priors is to draw random samples from priors and
transform these to more interpretable quantities (e.g. the mean sojourn
time) to determine what priors a given choice implies for those
interpretable quantities - starting with the defaults, and modifying by
trial and error if necessary.</p>
<p>A more detailed illustration of specifying priors informed by
background information will be given in the appendix of a forthcoming
paper.</p>
</div>
<div class="section level4">
<h4 id="comparing-the-gamma-and-weibull">Comparing the Gamma and Weibull<a class="anchor" aria-label="anchor" href="#comparing-the-gamma-and-weibull"></a>
</h4>
<p>We can roughly compare the fit of these models through their
likelihoods. The mode of the log posterior (i.e. the maximum penalised
likelihood, with the priors considered as a penalty) essentially
measures in-sample predictive ability. For a multi-state model, that is
the ability to predict an individual’s next observation given their
current and previous observations. Since the two models being compared
here have the same number of parameters, and the priors are of similar
strength, any improvement in the likelihood would suggest better
generalisability. In this case, the maximum log posteriors for these two
models are very similar.</p>
<p>(Cross-validation would be a better way of comparing, but it is
unclear how that might be set up with an intermittently-observed
multistate model)</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loglik.html">loglik</a></span><span class="op">(</span><span class="va">drawsg</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       name     posterior        mode</span></span>
<span><span class="co">## 1   loglik -143.7 ± 2.21 -142.235930</span></span>
<span><span class="co">## 2 logprior   -5.8 ± 0.77   -5.399696</span></span>
<span><span class="co">## 3  logpost -149.5 ± 2.29 -147.635626</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loglik.html">loglik</a></span><span class="op">(</span><span class="va">drawsw</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       name     posterior        mode</span></span>
<span><span class="co">## 1   loglik -144.8 ± 9.2  -142.200516</span></span>
<span><span class="co">## 2 logprior   -4.7 ± 1.4    -3.886514</span></span>
<span><span class="co">## 3  logpost -149.5 ± 10.0 -146.087029</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="sojourn-distribution">Sojourn distribution<a class="anchor" aria-label="anchor" href="#sojourn-distribution"></a>
</h4>
<p>The function <code><a href="../reference/soj_prob.html">soj_prob()</a></code> computes the probability of
staying in a given state, at a sequence of times, from a fitted
<code><a href="../reference/msmbayes.html">msmbayes()</a></code> model. It can be used to plot a kind of
“survival curve” for the sojourn distribution in a state. In this case,
there is little difference between the Weibull and Gamma distributions,
and a lot of uncertainty.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">t0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">6</span>, by<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="va">spg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/soj_prob.html">soj_prob</a></span><span class="op">(</span><span class="va">drawsg</span>,state<span class="op">=</span><span class="fl">1</span>,t<span class="op">=</span><span class="va">t0</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model<span class="op">=</span><span class="st">"Gamma"</span><span class="op">)</span></span>
<span><span class="va">spw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/soj_prob.html">soj_prob</a></span><span class="op">(</span><span class="va">drawsw</span>,state<span class="op">=</span><span class="fl">1</span>,t<span class="op">=</span><span class="va">t0</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model<span class="op">=</span><span class="st">"Weibull"</span><span class="op">)</span></span>
<span><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">spg</span>, <span class="va">spw</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">sp</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">median</span>, col<span class="op">=</span><span class="va">Model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">q5</span>, ymax<span class="op">=</span><span class="va">q95</span>, fill<span class="op">=</span><span class="va">Model</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Months"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Probability of remaining in state 1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="semimarkov_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>The mean of the sojourn distribution, the mean time to the next
transition on entry to a state, is given by <code><a href="../reference/mean_sojourn.html">mean_sojourn()</a></code>.
The mean of the phase-type approximation should agree with the mean of
the distribution that it was based on, since the approximation was
designed to match the first three moments. This is verified here for the
Gamma distribution, which has mean defined by
<code>shape x scale</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mean_sojourn.html">mean_sojourn</a></span><span class="op">(</span><span class="va">drawsg</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 3</span></span></span>
<span><span class="co">##   state    posterior  mode</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     1  1.61 <span style="color: #949494;">± 0.78</span> 1.51 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>     2  0.29 <span style="color: #949494;">± 0.14</span> 0.261</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">shape</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">drawsg</span>, pars<span class="op">=</span><span class="st">"shape"</span><span class="op">)</span></span>
<span><span class="va">scale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">drawsg</span>, pars<span class="op">=</span><span class="st">"scale"</span><span class="op">)</span></span>
<span><span class="va">shape</span><span class="op">$</span><span class="va">posterior</span> <span class="op">*</span> <span class="va">scale</span><span class="op">$</span><span class="va">posterior</span></span></code></pre></div>
<pre><code><span><span class="co">## rvar&lt;4000&gt;[2] <span style="color: #949494;">mean ± sd:</span></span></span>
<span><span class="co">## [1] 1.61 ± 0.78  0.29 ± 0.14</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="specifying-a-semi-markov-model-with-covariates">Specifying a semi-Markov model with covariates<a class="anchor" aria-label="anchor" href="#specifying-a-semi-markov-model-with-covariates"></a>
</h3>
<p>We now extend the Gamma model to include a covariate (binary,
representing sex) on the scale parameter for the distribution in both
states. The log likelihood hardly changes, as we might expect, as there
was no covariate effect assumed when the data were simulated, so this
model includes a lot of extra unnecessary parameters.</p>
<p>The prior for the shape parameter in this example is tightened to
support a slightly smaller range of values (up to
<code>exp(2*0.4) = 2.2</code>). With the default prior SD of 0.5, the
optimisation fails to converge, likely due to weak identifiability. We
see in the posterior summary that in fact the posteriors for the shape
parameters are similar to the priors, indicating weak information in the
data about these parameters.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drawsc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmbayes.html">msmbayes</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">infsim2</span>, state<span class="op">=</span><span class="st">"state"</span>, time<span class="op">=</span><span class="st">"months"</span>, subject<span class="op">=</span><span class="st">"subject"</span>,</span>
<span>                   pastates<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,</span>
<span>                   priors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/msmprior.html">msmprior</a></span><span class="op">(</span><span class="st">"logshape"</span>, mean<span class="op">=</span><span class="fl">0</span>, sd<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">~</span> <span class="va">male</span>, <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">~</span> <span class="va">male</span><span class="op">)</span>,</span>
<span>                   Q<span class="op">=</span><span class="va">Q</span>, fit_method<span class="op">=</span><span class="st">"optimize"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/loglik.html">loglik</a></span><span class="op">(</span><span class="va">drawsc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       name posterior       mode</span></span>
<span><span class="co">## 1   loglik -151 ± 21 -142.13004</span></span>
<span><span class="co">## 2 logprior  -12 ± 1   -11.02586</span></span>
<span><span class="co">## 3  logpost -163 ± 21 -153.15590</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">drawsc</span>, pars <span class="op">=</span> <span class="st">"shape"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">##   name  from    posterior  mode prior_string           prior</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> shape 1      1.1 <span style="color: #949494;">± 0.38</span> 1.04  1.0 (0.46, 2.19)  1.1 <span style="color: #949494;">± 0.45</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> shape 2      1.0 <span style="color: #949494;">± 0.12</span> 1.000 1.0 (0.46, 2.19)  1.1 <span style="color: #949494;">± 0.45</span></span></span></code></pre>
<div class="section level4">
<h4 id="time-acceleration-factors">Time acceleration factors<a class="anchor" aria-label="anchor" href="#time-acceleration-factors"></a>
</h4>
<p>The covariate effects in this model can be summarised as “time
acceleration factors”. In this case, their posterior distributions cover
a very wide interval, indicating a lack of information in the data and
no evidence for an effect in either direction.</p>
<blockquote>
<p>Note the use of the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> function on the object
returned by <code><a href="../reference/logtaf.html">taf()</a></code>, which applies a user-specified summary
to the <code>posterior</code> column of this object, as explained <a href="examples.html#rvar">here</a>). Note also <code>taf(...)</code> is
an alternative to <code>summary(..., pars="taf")</code>.</p>
</blockquote>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/logtaf.html">taf</a></span><span class="op">(</span><span class="va">drawsc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   from name posterior     mode</span></span>
<span><span class="co">## 1    1 male  20 ± 101 2.768362</span></span>
<span><span class="co">## 2    2 male  18 ± 79  2.556254</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/logtaf.html">taf</a></span><span class="op">(</span><span class="va">drawsc</span><span class="op">)</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   from name     mode       2.5%      50%    97.5%</span></span>
<span><span class="co">## 1    1 male 2.768362 0.05896570 2.953502 157.0297</span></span>
<span><span class="co">## 2    2 male 2.556254 0.05309879 2.614734 145.5197</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="outputs-from-fitted-models-by-covariates">Outputs from fitted models by covariates<a class="anchor" aria-label="anchor" href="#outputs-from-fitted-models-by-covariates"></a>
</h4>
<p>All standard multistate model outputs are supported for semi-Markov
models as for Markov models.</p>
<ul>
<li><p>Transition intensities (<code><a href="../reference/qdf.html">qdf()</a></code>,
<code><a href="../reference/qmatrix.html">qmatrix()</a></code>) for semi-Markov models are only defined on the
latent space of “phases” rather than observable states.</p></li>
<li><p>Transition probabilities over any time interval
(<code><a href="../reference/pmatrixdf.html">pmatrixdf()</a></code>,<code><a href="../reference/pmatrix.html">pmatrix()</a></code>) are available on the
space of observable or latent states. For observable states (the
default) this describes the probability of transitioning to <em>any</em>
phase of each “destination” state (summing over phases within a state),
for a person in the <em>first</em> phase of each “starting”
state.</p></li>
<li><p>Mean sojourn times <code><a href="../reference/mean_sojourn.html">mean_sojourn()</a></code>, or the total
length of stay <code><a href="../reference/totlos.html">totlos()</a></code> can be produced for either the
observable states or the latent phases.</p></li>
</ul>
<p>For example, the total length of time spent in each observable state,
over 12 months, is computed here for two different covariate values (men
and women). If <code>nd</code> is not supplied, the output is returned
for covariate values of zero.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>male<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/totlos.html">totlos</a></span><span class="op">(</span><span class="va">drawsc</span>, t<span class="op">=</span><span class="fl">12</span>, new_data<span class="op">=</span><span class="va">nd</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 4 × 4</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Groups:   state [2]</span></span></span>
<span><span class="co">##   state    posterior  male  mode</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     1  10.3 <span style="color: #949494;">± 0.37</span>     0 10.3 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>     1  10.2 <span style="color: #949494;">± 0.45</span>     1 10.2 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>     2   1.7 <span style="color: #949494;">± 0.37</span>     0  1.66</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span>     2   1.8 <span style="color: #949494;">± 0.45</span>     1  1.81</span></span></code></pre>
<p>Or for a standard population whose distribution matches the observed
distribution of covariates in the data frame <code>nd</code>, here 50%
men and 50% women:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/totlos.html">totlos</a></span><span class="op">(</span><span class="va">drawsc</span>, t<span class="op">=</span><span class="fl">12</span>, new_data<span class="op">=</span><span class="fu"><a href="../reference/standardise_to.html">standardise_to</a></span><span class="op">(</span><span class="va">nd</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 3</span></span></span>
<span><span class="co">##   state    posterior  mode</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     1  10.2 <span style="color: #949494;">± 0.41</span> 10.2 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>     2   1.8 <span style="color: #949494;">± 0.41</span>  1.77</span></span></code></pre>
<p>We may also break down the total length of time spent in each of the
five latent phases that comprise a stay in state 1 or state 2, though
this is only of academic interest. These are the states of the hidden
Markov model that is used to implement the semi-Markov model.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/totlos.html">totlos</a></span><span class="op">(</span><span class="va">drawsc</span>, t<span class="op">=</span><span class="fl">12</span>, states<span class="op">=</span><span class="st">"phase"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 5</span></span></span>
<span><span class="co">##    state      posterior          mode stateobs statephase</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 1p1    8.441 <span style="color: #949494;">± 1.207</span> 10.1                 1          1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 1p2    0.513 <span style="color: #949494;">± 0.311</span>  0.064<span style="text-decoration: underline;">3</span>              1          2</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 1p3    0.472 <span style="color: #949494;">± 0.280</span>  0.062<span style="text-decoration: underline;">9</span>              1          3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 1p4    0.431 <span style="color: #949494;">± 0.255</span>  0.061<span style="text-decoration: underline;">4</span>              1          4</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 1p5    0.393 <span style="color: #949494;">± 0.238</span>  0.060<span style="text-decoration: underline;">0</span>              1          5</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 2p1    1.607 <span style="color: #949494;">± 0.358</span>  1.66                2          1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 2p2    0.037 <span style="color: #949494;">± 0.029</span>  0.000<span style="text-decoration: underline;">000</span>051<span style="text-decoration: underline;">8</span>        2          2</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 2p3    0.036 <span style="color: #949494;">± 0.028</span>  0.000<span style="text-decoration: underline;">000</span>050<span style="text-decoration: underline;">9</span>        2          3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 2p4    0.036 <span style="color: #949494;">± 0.028</span>  0.000<span style="text-decoration: underline;">000</span>050<span style="text-decoration: underline;">0</span>        2          4</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 2p5    0.035 <span style="color: #949494;">± 0.027</span>  0.000<span style="text-decoration: underline;">000</span>049<span style="text-decoration: underline;">2</span>        2          5</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="semi-markov-models-with-competing-risks">Semi-Markov models with competing risks<a class="anchor" aria-label="anchor" href="#semi-markov-models-with-competing-risks"></a>
</h3>
<p>This is based on the dataset <code>illdeath_data</code>, a simulated
dataset with three states representing health, illness and death. Death
is allowed from either living state, and no recovery from the illness is
assumed.</p>
<p>State 1 is given a semi-Markov model with <code>pastates</code>.
There are “competing risks”, since on leaving state 1, an individual can
either get the illness or die without the illness. The binary covariate
“sex” modifies both the scale parameter for the sojourn time in state 2
(illness), the chance of moving to 3 (rather than 2) on leaving 1, and
the rate of transition from illness to death.</p>
<blockquote>
<p><strong>Note</strong> If the state, time and subject variables are
called “state”, “time”, and “subject”, we do not need to name them
explicitly in the call to <code><a href="../reference/msmbayes.html">msmbayes()</a></code>.</p>
</blockquote>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Qid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msmbayes.html">msmbayes</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">illdeath_data</span>, pastates<span class="op">=</span><span class="fl">1</span>,</span>
<span>                  covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span>,</span>
<span>                                    <span class="fu"><a href="../reference/rrnextdoc.html">rrnext</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span>,</span>
<span>                                    <span class="fu">Q</span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span><span class="op">)</span>,</span>
<span>                  Q<span class="op">=</span><span class="va">Qid</span>, fit_method<span class="op">=</span><span class="st">"optimize"</span><span class="op">)</span></span></code></pre></div>
<p>This model is a combination of a semi-Markov model for the transition
out of state 1, and a Markov model for the transition out of state 2,
with a phase-type approximation and exponential sojourn distributions
respectively.</p>
<div class="section level4">
<h4 id="summarising-covariate-effect-parameters">Summarising covariate effect parameters<a class="anchor" aria-label="anchor" href="#summarising-covariate-effect-parameters"></a>
</h4>
<p>The effects of covariates on progression are represented differently
for each of these states. For the risk of death from illness, the
covariate effect is a hazard ratio.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">draws</span>, pars<span class="op">=</span><span class="st">"hr"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          name from to posterior     mode   prior_string             prior</span></span>
<span><span class="co">## 1 hr(sexmale)    2  3 6.6 ± 6.6 4.782825 1 (0, 3.2e+08) 4.3e+11 ± 2.2e+13</span></span>
<span><span class="co">## 2 hr(sexmale)    2  3 6.6 ± 6.6 4.782825 1 (0, 3.2e+08) 4.3e+11 ± 2.2e+13</span></span></code></pre>
<p>For a person in state 1, without the illness, there are two aspects
of the covariate effect.</p>
<ul>
<li><p>A time acceleration factor <code>taf</code>, representing the
effect of time on the length of stay in state 1. A bigger
<code>taf</code> speeds up time, so that an effect size of 2 halves the
expected time to the next transition. For the exponential distribution,
this parameter has the same interpretation as the hazard ratio.</p></li>
<li><p>The multiplicative effect <code>rrnext</code> on the relative
risk of death without the illness, relative to a “baseline” risk of
getting the illness.</p></li>
</ul>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">draws</span>, pars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"taf"</span>,<span class="st">"rrnext"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              name from to        posterior       mode   prior_string</span></span>
<span><span class="co">## 1    taf(sexmale)    1 NA    2.6 ± 1.9     2.01522152 1 (0, 3.2e+08)</span></span>
<span><span class="co">## 2 rrnext(sexmale)    1  3 2174.9 ± 68510.3 0.05788637 1 (0, 3.2e+08)</span></span>
<span><span class="co">##               prior</span></span>
<span><span class="co">## 1 4.3e+11 ± 2.2e+13</span></span>
<span><span class="co">## 2 4.3e+11 ± 2.2e+13</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="summarising-outputs-by-covariates">Summarising outputs by covariates<a class="anchor" aria-label="anchor" href="#summarising-outputs-by-covariates"></a>
</h4>
<p>As covariates may influence the progression through the multi-state
system in many ways, how we build and summarise the model will depend on
the research question.</p>
<p>A useful general approach is compute an outcome of interest and
compare it between different covariate values. As an illustration, in
this model, suppose we are interested in the total time spent alive over
24 months for a person at the start of the study. First this is computed
for each covariate category to be compared (using
<code><a href="../reference/standardise_to.html">standardise_to()</a></code> as above, if necessary, to marginalise
over other covariates).</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/totlos.html">totlos</a></span><span class="op">(</span><span class="va">draws</span>, t<span class="op">=</span><span class="fl">24</span>, new_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>sex<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>,<span class="st">"female"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tl</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 4</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Groups:   state [3]</span></span></span>
<span><span class="co">##   state     posterior sex      mode</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;rvar[1d]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     1   1.31 <span style="color: #949494;">± 0.40</span> female  1.28 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>     1   0.85 <span style="color: #949494;">± 0.55</span> male    1.16 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>     2   0.72 <span style="color: #949494;">± 0.48</span> female  0.648</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span>     2   0.22 <span style="color: #949494;">± 0.17</span> male    0.293</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span>     3  21.96 <span style="color: #949494;">± 0.62</span> female 22.1  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span>     3  22.93 <span style="color: #949494;">± 0.65</span> male   22.5</span></span></code></pre>
<p>Posterior samples are then extracted for the time in state 1 and the
time in state 2 separately, for men and women separately.
<code>tl_12_male</code> (and <code>tl_12_female</code>) will then
comprise two <code>rvar</code> objects.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tl_12_male</span> <span class="op">&lt;-</span> <span class="va">tl</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op"><a href="https://mc-stan.org/posterior/reference/match.html" class="external-link">%in%</a></span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">sex</span><span class="op">==</span><span class="st">"male"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">posterior</span><span class="op">)</span> </span>
<span><span class="va">tl_12_female</span> <span class="op">&lt;-</span> <span class="va">tl</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op"><a href="https://mc-stan.org/posterior/reference/match.html" class="external-link">%in%</a></span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">sex</span><span class="op">==</span><span class="st">"female"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">posterior</span><span class="op">)</span></span>
<span><span class="va">tl_12_male</span></span></code></pre></div>
<pre><code><span><span class="co">## rvar&lt;4000&gt;[2] <span style="color: #949494;">mean ± sd:</span></span></span>
<span><span class="co">## [1] 0.85 ± 0.55  0.22 ± 0.17</span></span></code></pre>
<p>The posterior samples for state 1 and state 2 are added together to
give the posterior sample for the time spent alive. This is done for
women and men separately. Note <code>rvar_sum</code> is needed for this,
not the standard</p>
<p>Finally we obtain a posterior sample <code>tl_diff</code> for the
difference in the expected time spent alive for men and women.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/posterior/" class="external-link">posterior</a></span><span class="op">)</span></span>
<span><span class="va">tl_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/posterior/reference/rvar-summaries-within-draws.html" class="external-link">rvar_sum</a></span><span class="op">(</span><span class="va">tl_12_female</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://mc-stan.org/posterior/reference/rvar-summaries-within-draws.html" class="external-link">rvar_sum</a></span><span class="op">(</span><span class="va">tl_12_male</span><span class="op">)</span> </span></code></pre></div>
<blockquote>
<p><strong>Note:</strong> <code><a href="https://mc-stan.org/posterior/reference/rvar-summaries-within-draws.html" class="external-link">rvar_sum()</a></code> from the
<code>posterior</code> package is needed to add the “random variables”
represented by rvar objects, producing a random variable representing
their sum. The base R <code><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum()</a></code> function would collapse the
samples inside the rvar objects to produce a scalar, which is not what
we want here.</p>
</blockquote>
<p>A null hypothesis test for whether an effect is “significant” does
not have a direct analogue in Bayesian analysis. Instead I would
recommend summarising the posterior distribution of a quantity of
interest. This might be done in different ways, e.g. as a 95% credible
interval, or a posterior probability of exceeding a value of practical
interest (e.g. 0, or a clinically important value):</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">tl_diff</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">##   variable `2.5%` `50%` `97.5%`</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> tl_diff  -<span style="color: #BB0000;">0.656</span> 0.893    2.82</span></span></code></pre>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/infsim.html">mean</a></span><span class="op">(</span><span class="va">tl_diff</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.8735</span></span></code></pre>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
