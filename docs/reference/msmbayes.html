<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Bayesian multi-state models for intermittently-observed data — msmbayes • msmbayes</title><!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Bayesian multi-state models for intermittently-observed data — msmbayes"><meta name="description" content="Fit a multi-state model to longitudinal data consisting of
intermittent observation of a discrete state.  Bayesian estimation
is used, via the Stan software."><meta property="og:description" content="Fit a multi-state model to longitudinal data consisting of
intermittent observation of a discrete state.  Bayesian estimation
is used, via the Stan software."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">msmbayes</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/examples.html">Examples of using msmbayes</a></li>
    <li><a class="dropdown-item" href="../articles/misclass.html">Misclassification multi-state models in msmbayes</a></li>
    <li><a class="dropdown-item" href="../articles/semimarkov.html">Semi-Markov models with msmbayes</a></li>
    <li><a class="dropdown-item" href="../articles/nphase.html">Advanced phase-type models in msmbayes</a></li>
    <li><a class="dropdown-item" href="../articles/cognitive.html">Code for using the msmbayes package for semi-Markov modelling in an application to cognitive function</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/chjackson/msmbayes/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Bayesian multi-state models for intermittently-observed data</h1>
      <small class="dont-index">Source: <a href="https://github.com/chjackson/msmbayes/blob/HEAD/R/msmbayes.R" class="external-link"><code>R/msmbayes.R</code></a></small>
      <div class="d-none name"><code>msmbayes.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Fit a multi-state model to longitudinal data consisting of
intermittent observation of a discrete state.  Bayesian estimation
is used, via the Stan software.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">msmbayes</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  state <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>  subject <span class="op">=</span> <span class="st">"subject"</span>,</span>
<span>  <span class="va">Q</span>,</span>
<span>  covariates <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  pastates <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  pafamily <span class="op">=</span> <span class="st">"gamma"</span>,</span>
<span>  panphase <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  E <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  Efix <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  obstype <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  deathexact <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  obstrue <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  censor_states <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  constraint <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  nphase <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  priors <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  prob_initstate <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  soj_priordata <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  fit_method <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  keep_data <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>Data frame giving the observed data.</p></dd>


<dt id="arg-state">state<a class="anchor" aria-label="anchor" href="#arg-state"></a></dt>
<dd><p>Character string naming the observed state variable in
the data.  This variable must either be an integer in 1,2,...,K,
where K is the number of states, or a factor with these integers
as level labels.  If omitted, this is assumed to be <code>"state"</code>.</p></dd>


<dt id="arg-time">time<a class="anchor" aria-label="anchor" href="#arg-time"></a></dt>
<dd><p>Character string naming the observation time variable in the data.
If omitted, this is assumed to be <code>"time"</code>.</p></dd>


<dt id="arg-subject">subject<a class="anchor" aria-label="anchor" href="#arg-subject"></a></dt>
<dd><p>Character string naming the individual ID variable in the data.
If omitted, this is assumed to be <code>"subject"</code>.</p></dd>


<dt id="arg-q">Q<a class="anchor" aria-label="anchor" href="#arg-q"></a></dt>
<dd><p>Matrix indicating the transition structure.  A zero entry
indicates that instantaneous transitions from (row) to (column)
are disallowed.  An entry of 1 (or any other positive value)
indicates that the instantaneous transition is allowed.  The
diagonal of <code>Q</code> is ignored.</p>
<p>There is no need to "guess" initial values and put them here, as
is sometimes done in <code>msm</code>.  Initial values for fitting are
determined by Stan from the prior distributions, and the specific
values supplied for positive entries of <code>Q</code> are disregarded.</p></dd>


<dt id="arg-covariates">covariates<a class="anchor" aria-label="anchor" href="#arg-covariates"></a></dt>
<dd><p>Specification of covariates on transition intensities.
This should be a list of formulae, or a single formula.</p>
<p>If a list is supplied, each formula should have a
left-hand side that looks like <code>Q(r,s)</code>, and a right hand side
defining the regression model for the log of the transition intensity
from state \(r\) to state \(s\).</p>
<p>For example,</p>
<p><code>covariates = list(Q(1,2) ~ age + sex,
                        Q(2,1) ~ age)</code></p>
<p>specifies that the log of the 1-2 transition intensity is an additive
linear function of age and sex, and the log 2-1 transition intensity
is a linear function of age.  You do not have to list all of the
intensities here if some of them are not influenced by covariates.</p>
<p>If a single formula is supplied, this is assumed to apply to all
intensities.  If doing this, then take care with potential lack of
identifiability of effects from sparse data.</p>
<p>In models with phase-type approximated states (specified with
<code>pastates</code>), covariates are modelled through an accelerated failure
time model.  The effect is a multiplier on the scale parameter of
the sojourn distribution.  The covariate then has an identical
multiplicative effect on all rates of transition between phases for
a given state.  The left hand side of the formula should contain
<code>scale</code> instad of <code>Q</code>.  For example, if state 1 has a phase type
approximation, but state 2 is Markov, then we might supply
<code>covariates</code> as:</p>
<p><code>covariates = list(scale(1) ~ age + sex,
                        Q(2,1) ~ age)</code></p>
<p>In models with phase-type approximations and competing exit states,
covariates on the relative risk of different exit states are
specified with a formula with <code>rrnext</code> on the left hand side.  For
example in a model where state 1 has a phase-type approximation,
and the next state could be either 2 or 3, a linear model on the
log relative risk of transition to 3 (relative to the baseline 2)
might be specified as:</p>
<p><code>covariates = list(scale(1) ~ age + sex,
                        rrnext(1,3) ~ x + time)</code></p>
<p>In phase-type models specified with <code>nphase</code>, or misclassification
models (specified with <code>E</code>), covariates on transition intensities
are specified with <code>Q()</code>, where the numbers inside <code>Q()</code> refer to
the latent state space.</p></dd>


<dt id="arg-pastates">pastates<a class="anchor" aria-label="anchor" href="#arg-pastates"></a></dt>
<dd><p>This indicates which states (if any) are given a
Weibull or Gamma sojourn distribution approximated by a phase-type model
Ignored if <code>nphase</code> is supplied.</p></dd>


<dt id="arg-pafamily">pafamily<a class="anchor" aria-label="anchor" href="#arg-pafamily"></a></dt>
<dd><p><code>"weibull"</code> or <code>"gamma"</code>, indicating the
approximated sojourn distribution in the phased state.  Either a
vector of the same length as <code>pastates</code>, or just one to apply to
all states.</p></dd>


<dt id="arg-panphase">panphase<a class="anchor" aria-label="anchor" href="#arg-panphase"></a></dt>
<dd><p>Number of phases to use for each state given a
phase-type Gamma or Weibull approximation.  Vector of same length
as <code>pastates</code>. More phases allow a wider range of shape parameters.</p></dd>


<dt id="arg-e">E<a class="anchor" aria-label="anchor" href="#arg-e"></a></dt>
<dd><p>By default, <code>msmbayes</code> fits a (non-hidden) Markov model.
If <code>E</code> is supplied, then a Markov model with misclassification is
fitted, a type of hidden Markov model.  <code>E</code> should then be a
matrix indicating the structure of allowed misclassifications,
where rows are the true states, and columns are the observed
states.  A zero entry in row \(r\) and column \(s\) indicates
that true state \(r\) cannot be observed as state
\(s\).  A non-zero \((r,s)\) entry indicates that true state
\(r\) may be misclassified as \(s\). The diagonal of <code>E</code>
is ignored.</p></dd>


<dt id="arg-efix">Efix<a class="anchor" aria-label="anchor" href="#arg-efix"></a></dt>
<dd><p>Misclassfication probabilities in Markov models are
commonly not identifiable from data, particulary if the data are
intermittently observed.  Instead of estimating them, a Markov
model with misclassification can be specified by supplying
assumed misclassification probabilities in the <code>Efix</code>
argument.  This is a matrix with same dimensions as E.  Any
non-zero entries of <code>Efix</code> indicate the fixed
known value for the corresponding misclassification probability.
The \((r,s)\) entry of <code>Efix</code> is 0 for any error probabilities
that are estimated from the data or not permitted.</p></dd>


<dt id="arg-obstype">obstype<a class="anchor" aria-label="anchor" href="#arg-obstype"></a></dt>
<dd><p>Character string, giving a variable in the data
which defines what a "row of the data" means.  The variable
must contain only the following values, which may be different
in different rows:</p>
<p><code>1</code>: Intermittent observation. The state is unknown between the
previous observation and the current observation (other than any
knowledge implied by the structure <code>Q</code> of permitted transitions).</p>
<p><code>2</code>: Exact transition times. The state is constant at the
previous observed value between the previous and current times in
the data, and the transition to the current state is made exactly
at the current time.</p>
<p><code>3</code>: "Exact death times". A transition to the current state is
made exactly at the current time, but the state in the period
between the previous observation and this transition is unknown.
Typical (but not necessary) for observations of death in
epidemiological/clinical studies.</p>
<p>This is the same feature as in the <code>msm</code> package.  If omitted,
then all observations are assumed to be intermittent, with
<code>obstype</code> 1.</p></dd>


<dt id="arg-deathexact">deathexact<a class="anchor" aria-label="anchor" href="#arg-deathexact"></a></dt>
<dd><p>Set to <code>TRUE</code> if death times are observed with
the <code>obstype 3</code> scheme.  This is a shortcut for including an
<code>obstype</code> variable with 3 in the positions with the absorbing
state, and 1 elsewhere.  If there are multiple absorbing states,
then this is taken to only apply to the last of them in the
state space - use an <code>obstype</code> variable if you want it to apply
to all absorbing states.</p></dd>


<dt id="arg-obstrue">obstrue<a class="anchor" aria-label="anchor" href="#arg-obstrue"></a></dt>
<dd><p>Only applicable to models with misclassification.  A
character string indicating a variable in the data whose value is
1 if the true state is known to equal the value in "state", and 0
otherwise.</p></dd>


<dt id="arg-censor-states">censor_states<a class="anchor" aria-label="anchor" href="#arg-censor-states"></a></dt>
<dd><p>A named list indicating the codes used for
"censored" states.  This is used when there are observations that
are known to be one of a subset of states, but it is not known
which.  The names of the list indicate codes that may appear in
the <code>"state"</code> variable.  The values of the corresponding component
indicate the subset which is represented by the code.  For
example</p>
<p><code>censor_states = list("99" = c(2,3), "999" = c(3,4))</code></p>
<p>means that a code of 99 in the <code>"state"</code> variable indicates
"state is either 2 or 3 at this time", and a code of 999
indicates "state is either 3 or 4".</p>
<p>Note the names of the list must be quoted strings that are
interpretable as integers, since the <code>"state"</code> variable must be
an integer.</p>
<p>In misclassification models, the subset refers to values of the
true state if <code>obstrue</code> is 1, or the observed state if <code>obstrue</code>
is 0.</p>
<p>Unlike in <code>msm</code>, there is no <code>censor</code> argument, and a <code>censor_states</code>
must be supplied if there are censored states.</p></dd>


<dt id="arg-constraint">constraint<a class="anchor" aria-label="anchor" href="#arg-constraint"></a></dt>
<dd><p>Constraints that a covariate has an equal effect
on a particular set of transition intensities.  A list with one
component for each covariate that has constraints.  Each
component is a list of sets (or a single set) of intensities
where the effect of that covariate is equal.  For example, to
constrain the effect of age to be equal for transitions 1-2 and
2-3, and also equal for transitions 1-4 and 2-4, and the effect
of sexMALE to be equal for transitions 1-2 and 2-3, specify</p>
<p><code>constraint = list(age = list(c("1-2","2-3"), c("1-4","2-4")), sex = list(c("1-2","2-3")))</code></p>
<p>This is the same feature as in <code>msm</code>, but with an easier
interface.  In <code>msmbayes</code> it is only supported for standard Markov
models, not semi-Markov, phase-type or misclassification models.</p></dd>


<dt id="arg-nphase">nphase<a class="anchor" aria-label="anchor" href="#arg-nphase"></a></dt>
<dd><p>Only required for models with phase-type sojourn
distributions specified directly (not through <code>pastates</code>).
<code>nphase</code> is a vector with one element per state, giving the
number of phases per state.  This element is 1 for states that do
not have phase-type sojourn distributions.</p></dd>


<dt id="arg-priors">priors<a class="anchor" aria-label="anchor" href="#arg-priors"></a></dt>
<dd><p>A list specifying priors.  Each component should be
the result of a call to <code><a href="msmprior.html">msmprior</a></code>.  Any parameters
with priors not specified here are given default priors: normal
with mean -2 and SD 2 for log intensities, normal with mean
0 and SD 10 for log hazard ratios, normal(0,1) for log odds parameters
in misclassification models.</p>
<p>In phase-type approximation models, the default priors are normal
with mean 2, SD 2 for scale parameters (i.e. the log inverse of the
default prior for the rate), normal(0, SD=0.5) truncated on the
supported region for log shape parameters, and normal(0,1) for log
odds of transition (relative to first exit state) in structures
with competing exit states.</p>
<p>See <code><a href="msmprior.html">msmprior</a></code> for more details.</p>
<p>If only one parameter is given a non-default prior, a single <code>msmprior</code>
call can be supplied here instead of a list.</p>
<p>Maximum likelihood estimation can be performed by setting
<code>priors="mle"</code>, and using <code>fit_method="optimize"</code>.  This is
equivalent to estimating the posterior mode with improper uniform
priors on the unconstrained parameter space (i.e. positive
parameters on the log scale).  Uncertainty is then quantified by
sampling from the multivariate normal defined by the Hessian at the
mode .  The sample can be summarised to produce confidence
intervals, as in the <code>ci="normal"</code> method in the <code>msm</code> package.
These are equivalent to credible intervals from a Laplace
approximation to the posterior.</p></dd>


<dt id="arg-prob-initstate">prob_initstate<a class="anchor" aria-label="anchor" href="#arg-prob-initstate"></a></dt>
<dd><p>Probabilities of true states at a person's first
observation time in a misclassification or model.  If supplied,
this should be a matrix with a row for each individual subject,
and a column for each true state, or a vector with one element
for each state that is assumed to apply to all individuals.</p>
<p>If not supplied, every person is assumed to be in state 1 with
probability 1 in misclassification models, or phase 1 of the
observed state with probability 1 in phase-type models.  Note
no warning is currently given if the first observed state would
be impossible if the person was really in state 1.</p>
<p>This applies to both misclassification models, and phase-type
models where a person's first observed state is phased.  If the
first observed state is not phased or misclassified, then this is
ignored.</p></dd>


<dt id="arg-soj-priordata">soj_priordata<a class="anchor" aria-label="anchor" href="#arg-soj-priordata"></a></dt>
<dd><p>Synthetic data that represents prior information
about the mean sojourn times.  Experimental, undocumented feature.</p></dd>


<dt id="arg-fit-method">fit_method<a class="anchor" aria-label="anchor" href="#arg-fit-method"></a></dt>
<dd><p>Quoted string specifying the algorithm to fit the
model.  <code>"sample"</code> uses NUTS/HMC MCMC, via
<code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">rstan::sampling()</a></code>.  This is the default unless <code>priors="mle"</code>.
Alternatives are</p>
<p><code>"optimize"</code> to use posterior mode optimization (with respect
to parameters on the log scale) followed by Laplace approximation
around the mode (via <code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-optimizing.html" class="external-link">rstan::optimizing()</a></code>). This is the default
if <code>priors="mle"</code>.</p>
<p><code>"variational"</code> to use variational Bayes (via <code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-vb.html" class="external-link">rstan::vb()</a></code>).</p>
<p><code>"pathfinder"</code>, to use the Pathfinder variational algorithm
via <code>cmdstanr</code>.  This requires <code>cmdstan</code> and <code>cmdstanr</code> to be
installed.  The first time this is run for a particular <code>msmbayes</code>
model class, the Stan program for that class is compiled, which
will take a extra minute or two.  The next time, it will not need
to be recompiled.  This also assumes you have write permission to
the place where <code>msmbayes</code> is installed.</p></dd>


<dt id="arg-keep-data">keep_data<a class="anchor" aria-label="anchor" href="#arg-keep-data"></a></dt>
<dd><p>Store a copy of the cleaned data in the returned
object.  <code>FALSE</code> by default.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Other arguments to be passed to the function from
<code>rstan</code> or <code>cmdstanr</code> that fits the model.  Note that initial
values are determined by sampling from the prior (after
dividing the prior SD 5), not using
Stan's default, but this can be overridden here (currently
not documented - this needs knowledge of the Stan variable names
and formats)</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A data frame in the <code>draws</code> format of the
<span class="pkg">posterior</span> package, containing draws from the posterior of
the model parameters.</p>
<p>Attributes are added to give information about the model structure,
and a class <code>"msmbayes"</code> is prepended.</p>
<p>See, e.g. <code><a href="summary.msmbayes.html">summary.msmbayes</a></code>, <code><a href="qdf.html">qdf</a></code>,
<code><a href="loghr.html">hr</a></code>, and similar functions, to extract parameter
estimates from the fitted model.</p>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

